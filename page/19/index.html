<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="baidu-site-verification" content="codeva-6wmKWl5hmx" />
<meta name="bytedance-verification-code" content="GcOf/MpQ8shZ5Hh/2hvr" />
<meta name="google-site-verification" content="wivqPhuFdISMEKkFZjOWHPYJGSvd716d9R7Bwy2Jj-A" />
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-4636539228226058"
     crossorigin="anonymous"></script>
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.1.1">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha256-yIDrPSXHZdOZhAqiBP7CKzIwMQmRCJ8UeB8Jo17YC4o=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"www.vvbuys.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.19.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="Share some post and some issue for linux program">
<meta property="og:type" content="website">
<meta property="og:title" content="VVbugs Blog">
<meta property="og:url" content="https://www.vvbuys.com/page/19/index.html">
<meta property="og:site_name" content="VVbugs Blog">
<meta property="og:description" content="Share some post and some issue for linux program">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="vvbuys">
<meta property="article:tag" content="Linux hyprland Python Rust Golang javascript">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://www.vvbuys.com/page/19/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/19/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>VVbugs Blog - standalone Linux lover</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">VVbugs Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">standalone Linux lover</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li><li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li><li class="menu-item menu-item-commonweal"><a href="/404/" rel="section"><i class="fa fa-heartbeat fa-fw"></i>Commonweal 404</a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">vvbuys</p>
  <div class="site-description" itemprop="description">Share some post and some issue for linux program</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">265</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">36</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.vvbuys.com/read_sf_lf/2019-01-12-sf-lf-12-imp/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vvbuys">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VVbugs Blog">
      <meta itemprop="description" content="Share some post and some issue for linux program">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | VVbugs Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/read_sf_lf/2019-01-12-sf-lf-12-imp/" class="post-title-link" itemprop="url">「SF-LC」12 Imp</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-02 01:05:07" itemprop="dateCreated datePublished" datetime="2024-02-02T01:05:07+00:00">2024-02-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight pascal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Z ::= X;;</span><br><span class="line">Y ::= <span class="number">1</span>;;</span><br><span class="line"><span class="keyword">WHILE</span> ~(Z = <span class="number">0</span>) <span class="keyword">DO</span></span><br><span class="line">  Y ::= Y * Z;;</span><br><span class="line">  Z ::= Z - <span class="number">1</span></span><br><span class="line"><span class="keyword">END</span></span><br></pre></td></tr></table></figure>

<p>A weird convention through out all IMP is:</p>
<ul>
<li><code>a-</code>: arith </li>
<li><code>b-</code>: bool</li>
<li><code>c-</code>: command</li>
</ul>
<h2 id="Arithmetic-and-Boolean-Expression"><a href="#Arithmetic-and-Boolean-Expression" class="headerlink" title="Arithmetic and Boolean Expression"></a>Arithmetic and Boolean Expression</h2><h3 id="Abstract-Syntax"><a href="#Abstract-Syntax" class="headerlink" title="Abstract Syntax"></a>Abstract Syntax</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">a ::=</span><br><span class="line">    | <span class="type">nat</span></span><br><span class="line">    | <span class="type">a</span> + a</span><br><span class="line">    | <span class="type">a</span> - a</span><br><span class="line">    | <span class="type">a</span> * a</span><br><span class="line">b ::= </span><br><span class="line">    | <span class="type">true</span></span><br><span class="line">    | <span class="type">false</span></span><br><span class="line">    | <span class="type">a</span> = a</span><br><span class="line">    | <span class="type">a</span> ≤ a</span><br><span class="line">    | <span class="type">¬b</span></span><br><span class="line">    | <span class="type">b</span> &amp;&amp; b</span><br></pre></td></tr></table></figure>

<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Inductive</span> aexp : <span class="keyword">Type</span> :=</span><br><span class="line">  | <span class="type">ANum</span> (n : nat)</span><br><span class="line">  | <span class="type">APlus</span> (a1 a2 : aexp)</span><br><span class="line">  | <span class="type">AMinus</span> (a1 a2 : aexp)</span><br><span class="line">  | <span class="type">AMult</span> (a1 a2 : aexp).</span><br><span class="line"><span class="keyword">Inductive</span> bexp : <span class="keyword">Type</span> :=</span><br><span class="line">  | <span class="type">BTrue</span></span><br><span class="line">  | <span class="type">BFalse</span></span><br><span class="line">  | <span class="type">BEq</span> (a1 a2 : aexp)</span><br><span class="line">  | <span class="type">BLe</span> (a1 a2 : aexp)</span><br><span class="line">  | <span class="type">BNot</span> (b : bexp)</span><br><span class="line">  | <span class="type">BAnd</span> (b1 b2 : bexp).</span><br></pre></td></tr></table></figure>

<h3 id="Evaluation"><a href="#Evaluation" class="headerlink" title="Evaluation"></a>Evaluation</h3><p>TODO: is this considered as “denotational semantics”?</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Fixpoint</span> aeval (a : aexp) : nat :=</span><br><span class="line">  <span class="keyword">match</span> a <span class="built_in">with</span></span><br><span class="line">  | <span class="type">ANum</span> n ⇒ n</span><br><span class="line">  | <span class="type">APlus</span> a1 a2 ⇒ (aeval a1) + (aeval a2)</span><br><span class="line">  | <span class="type">AMinus</span> a1 a2 ⇒ (aeval a1) - (aeval a2)</span><br><span class="line">  | <span class="type">AMult</span> a1 a2 ⇒ (aeval a1) * (aeval a2)</span><br><span class="line">  <span class="keyword">end</span>.</span><br><span class="line"><span class="keyword">Fixpoint</span> beval (b : bexp) : bool :=</span><br><span class="line">  <span class="keyword">match</span> b <span class="built_in">with</span></span><br><span class="line">  | <span class="type">BTrue</span> ⇒ true</span><br><span class="line">  | <span class="type">BFalse</span> ⇒ false</span><br><span class="line">  | <span class="type">BEq</span> a1 a2 ⇒ (aeval a1) =? (aeval a2)</span><br><span class="line">  | <span class="type">BLe</span> a1 a2 ⇒ (aeval a1) &lt;=? (aeval a2)</span><br><span class="line">  | <span class="type">BNot</span> b1 ⇒ negb (beval b1)</span><br><span class="line">  | <span class="type">BAnd</span> b1 b2 ⇒ andb (beval b1) (beval b2)</span><br><span class="line">  <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<p>Supposed we have a <code>Fixpoint optimize_0plus (a:aexp) : aexp</code></p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Theorem</span> optimize_0plus_sound: ∀a,</span><br><span class="line">  aeval (optimize_0plus a) = aeval a.</span><br></pre></td></tr></table></figure>

<p>During the proof, many cases of <code>destruct aexp</code> are similar!<br>Recursive cases such as <code>APlus, AMinus, AMult</code> all require duplicated <code>IH</code> application.</p>
<blockquote>
<p>From Coq Intensive:<br>when we <code>simpl</code> on <code>APlus</code> case. it’s not “simplified” but give us a pattern matching.<br>That’s a hint that we need to furthur case analysis by <code>destruct n</code> as <code>0</code> case or <code>_</code> case.</p>
</blockquote>
<h2 id="Coq-Automation"><a href="#Coq-Automation" class="headerlink" title="Coq Automation"></a>Coq Automation</h2><h3 id="Tacticals"><a href="#Tacticals" class="headerlink" title="Tacticals"></a>Tacticals</h3><blockquote>
<p>“higher-order tactics”.</p>
</blockquote>
<h4 id="try-T-and-tacticals"><a href="#try-T-and-tacticals" class="headerlink" title="try T and ; tacticals"></a><code>try T</code> and <code>;</code> tacticals</h4><blockquote>
<p>if <code>T</code> fail, <code>try T</code> successfully does nothing at all</p>
</blockquote>
<blockquote>
<p><code>T;T&#39;</code> : performs <code>T&#39;</code> on each subgoal generated by <code>T</code>.</p>
</blockquote>
<p>Super blindly but useful: (only leave the “interesting” one.)</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">induction</span> a;</span><br><span class="line">    <span class="comment">(* Most cases follow directly by the IH... *)</span></span><br><span class="line">    <span class="built_in">try</span> (<span class="built_in">simpl</span>; <span class="built_in">rewrite</span> IHa1; <span class="built_in">rewrite</span> IHa2; <span class="built_in">reflexivity</span>).</span><br><span class="line">    <span class="comment">(* ... or are immediate by definition *)</span></span><br><span class="line">    <span class="built_in">try</span> <span class="built_in">reflexivity</span>.</span><br></pre></td></tr></table></figure>

<p><code>.</code> is the atomic<br><code>;</code> cannot be stepped into…</p>
<h4 id="T-T1-T2-Tn-tacticals"><a href="#T-T1-T2-Tn-tacticals" class="headerlink" title="T; [T1 | T2 | ... | Tn] tacticals"></a><code>T; [T1 | T2 | ... | Tn]</code> tacticals</h4><blockquote>
<p>general form or <code>;</code><br><code>T;T&#39;</code> is shorthand for: <code>T; [T&#39; | T&#39; | ... | T&#39;]</code>.</p>
</blockquote>
<h4 id="repeat-tacticals"><a href="#repeat-tacticals" class="headerlink" title="repeat tacticals"></a><code>repeat</code> tacticals</h4><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Theorem</span> In10 : In <span class="number">10</span> [<span class="number">1</span>;<span class="number">2</span>;<span class="number">3</span>;<span class="number">4</span>;<span class="number">5</span>;<span class="number">6</span>;<span class="number">7</span>;<span class="number">8</span>;<span class="number">9</span>;<span class="number">10</span>].</span><br><span class="line"><span class="keyword">Proof</span>.</span><br><span class="line">  <span class="built_in">repeat</span> (<span class="built_in">try</span> (<span class="built_in">left</span>; <span class="built_in">reflexivity</span>); <span class="built_in">right</span>). <span class="keyword">Qed</span>.</span><br></pre></td></tr></table></figure>

<ul>
<li>stop when it fails</li>
<li>always succeeds, then loop forever! e.g. <code>repeat simpl</code></li>
</ul>
<blockquote>
<p>This does not affect Coq’s logical consistency,<br>construction process diverges means we have failed to construct a proof, not that we have constructed a wrong one.</p>
</blockquote>
<h3 id="Defining-New-Tactic-Notations"><a href="#Defining-New-Tactic-Notations" class="headerlink" title="Defining New Tactic Notations"></a>Defining New Tactic Notations</h3><ul>
<li><code>Tactic Notation</code>: syntax extension for tactics (good for simple <em>macros</em>)</li>
</ul>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Tactic</span> <span class="keyword">Notation</span> <span class="string">&quot;simpl_and_try&quot;</span> <span class="built_in">tactic</span>(c) :=</span><br><span class="line">  <span class="built_in">simpl</span>; <span class="built_in">try</span> c.</span><br></pre></td></tr></table></figure>

<ul>
<li><code>Ltac</code>: scripting language for tactics (good for more sophisticated proof engineering)</li>
<li>OCaml tactic scripting API (for wizards)</li>
</ul>
<h3 id="The-omega-Tactic"><a href="#The-omega-Tactic" class="headerlink" title="The omega Tactic"></a>The <code>omega</code> Tactic</h3><blockquote>
<p><em>Presburger arithmetic</em></p>
</blockquote>
<ul>
<li>arith, equality, ordering, logic connectives</li>
<li><code>O(doubly expontential)</code></li>
</ul>
<h3 id="A-Few-More-Handy-Tactics"><a href="#A-Few-More-Handy-Tactics" class="headerlink" title="A Few More Handy Tactics"></a>A Few More Handy Tactics</h3><ul>
<li><code>clear H</code></li>
<li><code>subst x</code>, <code>subst</code></li>
<li><code>rename ... into ...</code>  (change auto-generated name that we don’t like…)</li>
</ul>
<p>the below three are very useful in Coq Automation (w&#x2F; <code>try T; T&#39;</code>) </p>
<ul>
<li><code>assumption</code></li>
<li><code>contradiction</code></li>
<li><code>constructor</code>  (try to <code>apply</code> all constructors.<br>            Problem: might have multiple constructors applicable but some fail)</li>
</ul>
<h2 id="Evaluation-as-a-Relation"><a href="#Evaluation-as-a-Relation" class="headerlink" title="Evaluation as a Relation"></a>Evaluation as a Relation</h2><p>Defined as Binary relation on <code>aexp × nat</code>.<br>Exactly <em>Big Step &#x2F; Structural Operational Semantics</em>.</p>
<p>More flexible than <code>Fixpoint</code> (computation, or <em>Denotational</em>).<br>…Since we can operate on <code>Inductive</code> as data I guess?<br>…and we can also <code>induction</code> on the relation.<br>…and when things getting more and more “un-computable” <em>(see below)</em>.</p>
<blockquote>
<p>译注：求值关系不满足对称性，因为它是有方向的。</p>
</blockquote>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Inductive</span> aevalR : aexp → nat → <span class="keyword">Prop</span> :=</span><br><span class="line">  | <span class="type">E_ANum</span> n :</span><br><span class="line">      aevalR (ANum n) n</span><br><span class="line">  | <span class="type">E_APlus</span> (e1 e2: aexp) (n1 n2: nat) :</span><br><span class="line">      aevalR e1 n1 →</span><br><span class="line">      aevalR e2 n2 →</span><br><span class="line">      aevalR (APlus e1 e2) (n1 + n2)</span><br><span class="line">  | <span class="type">E_AMinus</span> (e1 e2: aexp) (n1 n2: nat) :</span><br><span class="line">      aevalR e1 n1 →</span><br><span class="line">      aevalR e2 n2 →</span><br><span class="line">      aevalR (AMinus e1 e2) (n1 - n2)</span><br><span class="line">  | <span class="type">E_AMult</span> (e1 e2: aexp) (n1 n2: nat) :</span><br><span class="line">      aevalR e1 n1 →</span><br><span class="line">      aevalR e2 n2 →</span><br><span class="line">      aevalR (AMult e1 e2) (n1 * n2).</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Noticed now we now define <code>inductive</code> in a mixed style:<br>some arg is before <code>:</code> (named), some are after <code>:</code> (anonymous).</p>
</blockquote>
<p>We could do this as well</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| <span class="type">E_APlus</span> (e1 e2: aexp) (n1 n2: nat)</span><br><span class="line">     (H1 : aevalR e1 n1)</span><br><span class="line">     (H2 : aevalR e2 n2) :</span><br><span class="line">     aevalR (APlus e1 e2) (n1 + n2)</span><br></pre></td></tr></table></figure>

<p><code>Reserved Notation</code> allow us using the notation during the definition!</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Reserved</span> <span class="keyword">Notation</span> <span class="string">&quot;e &#x27;\\&#x27; n&quot;</span> (<span class="built_in">at</span> level <span class="number">90</span>, <span class="built_in">left</span> associativity).</span><br><span class="line"></span><br><span class="line"><span class="keyword">Inductive</span> aevalR : aexp → nat → <span class="keyword">Prop</span> :=</span><br><span class="line">  | <span class="type">E_ANum</span> (n : nat) :</span><br><span class="line">      (ANum n) \\ n</span><br><span class="line">  | <span class="type">E_APlus</span> (e1 e2 : aexp) (n1 n2 : nat) :</span><br><span class="line">      (e1 \\ n1) → </span><br><span class="line">      (e2 \\ n2) → </span><br><span class="line">      (APlus e1 e2) \\ (n1 + n2)</span><br><span class="line">  | <span class="type">E_AMinus</span> (e1 e2 : aexp) (n1 n2 : nat) :</span><br><span class="line">      (e1 \\ n1) → </span><br><span class="line">      (e2 \\ n2) → </span><br><span class="line">      (AMinus e1 e2) \\ (n1 - n2)</span><br><span class="line">  | <span class="type">E_AMult</span> (e1 e2 : aexp) (n1 n2 : nat) :</span><br><span class="line">      (e1 \\ n1) → </span><br><span class="line">      (e2 \\ n2) → </span><br><span class="line">      (AMult e1 e2) \\ (n1 * n2)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">where</span> <span class="string">&quot;e &#x27;\\&#x27; n&quot;</span> := (aevalR e n) : type_scope.</span><br></pre></td></tr></table></figure>

<p>I hated this infix <code>\\</code> notation…it tries to mimic <code>⇓</code> (double down arrow).</p>
<pre><code>                           e1 \\ n1
                           e2 \\ n2
                     -------------------- (E_APlus)
                     APlus e1 e2 \\ n1+n2
</code></pre>
<p>is actually:</p>
<pre><code>                           e1 ⇓ n1
                           e2 ⇓ n2
                     -------------------- (E_APlus)
                     APlus e1 e2 ⇓ n1+n2
</code></pre>
<blockquote>
<p>Coq Intensive:<br>If you have two variables above the line. Think about if you need <code>generalize dependent</code>. </p>
</blockquote>
<h3 id="Computational-vs-Relational-Definitions-INTERESTING"><a href="#Computational-vs-Relational-Definitions-INTERESTING" class="headerlink" title="Computational vs. Relational Definitions INTERESTING"></a>Computational vs. Relational Definitions <em>INTERESTING</em></h3><p>In some cases, relational definition are much better than computational (a.k.a. functional).</p>
<blockquote>
<p>for situations, where thing beingdefined is not easy to express as a function (or not a function at all)</p>
</blockquote>
<h4 id="case-1-safe-division"><a href="#case-1-safe-division" class="headerlink" title="case 1 - safe division"></a>case 1 - safe division</h4><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Inductive</span> aexp : <span class="keyword">Type</span> :=</span><br><span class="line">| <span class="type">ADiv</span> (a1 a2 : aexp). <span class="comment">(* &lt;--- NEW *)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>functional: how to return <code>ADiv (ANum 5) (ANum 0)</code>? probably has to be <code>option</code> (Coq is total!)</li>
<li>relational: <code>(a1 \\ n1) → (a2 \\ n2) → (n2 &gt; 0) → (mult n2 n3 = n1) → (ADiv a1 a2) \\ n3</code>.<ul>
<li>we can add a constraint <code>(n2 &gt; 0)</code>.</li>
</ul>
</li>
</ul>
<h4 id="case-2-non-determinism"><a href="#case-2-non-determinism" class="headerlink" title="case 2 - non-determinism"></a>case 2 - non-determinism</h4><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Inductive</span> aexp : <span class="keyword">Type</span> :=</span><br><span class="line">| <span class="type">AAny</span> <span class="comment">(* &lt;--- NEW *)</span></span><br></pre></td></tr></table></figure>
<ul>
<li>functional: not a deterministic function…</li>
<li>relational: <code>E_Any (n : nat) : AAny \\ n</code> … just say it’s the case.</li>
</ul>
<p>Nonetheless, functional definition is good at:</p>
<ol>
<li>by definition deterministic (need proof in relational case)</li>
<li>take advantage of Coq’s computation engine.</li>
<li>function can be directly “extracted” from Gallina to OCaml&#x2F;Haskell</li>
</ol>
<p>In large Coq developments:</p>
<ol>
<li>given <em>both</em> styles</li>
<li>a lemma stating they coincise (等价)</li>
</ol>
<h2 id="Expressions-with-Variables"><a href="#Expressions-with-Variables" class="headerlink" title="Expressions with Variables"></a>Expressions with Variables</h2><h3 id="State-Environment-环境"><a href="#State-Environment-环境" class="headerlink" title="State (Environment) 环境"></a>State (Environment) 环境</h3><blockquote>
<p>A <em>machine state</em> (or just <em>state</em>) represents the current values of <em>all variables</em> at some point in the execution of a program.</p>
</blockquote>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Definition</span> state := total_map nat.</span><br></pre></td></tr></table></figure>


<h3 id="Syntax"><a href="#Syntax" class="headerlink" title="Syntax"></a>Syntax</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Inductive</span> aexp : <span class="keyword">Type</span> :=</span><br><span class="line">  | <span class="type">AId</span> (x : string) <span class="comment">(* &lt;--- NEW *)</span></span><br></pre></td></tr></table></figure>


<h3 id="Notations-Coercisons-–-“meta-programming”-and-AST-quasi-quotation"><a href="#Notations-Coercisons-–-“meta-programming”-and-AST-quasi-quotation" class="headerlink" title="Notations &amp; Coercisons – “meta-programming” and AST quasi-quotation"></a>Notations &amp; Coercisons – “meta-programming” and AST quasi-quotation</h3><h4 id="Quasi-quotation"><a href="#Quasi-quotation" class="headerlink" title="Quasi-quotation"></a>Quasi-quotation</h4><p><a target="_blank" rel="noopener" href="https://whitequark.org/blog/2014/04/16/a-guide-to-extension-points-in-ocaml/">OCaml PPX &amp; AST quasi-quotation</a></p>
<blockquote>
<p>quasi-quotation enables one to introduce symbols that stand for a linguistic expression in a given instance and are used as that linguistic expression in a different instance.</p>
</blockquote>
<p>e.g. in above OCaml example, you wrote <code>%expr 2 + 2</code> and you get <code>[%expr [%e 2] + [%e 2]]</code>.</p>
<h4 id="Coq’s-Notation-Scope-Coercision-built-in-Quasi-quotation"><a href="#Coq’s-Notation-Scope-Coercision-built-in-Quasi-quotation" class="headerlink" title="Coq’s Notation Scope + Coercision &#x3D;&#x3D; built-in Quasi-quotation"></a>Coq’s <em>Notation Scope</em> + Coercision &#x3D;&#x3D; built-in Quasi-quotation</h4><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">(** Coercision for constructors **)</span></span><br><span class="line"><span class="keyword">Coercion</span> AId : string &gt;-&gt; aexp.</span><br><span class="line"><span class="keyword">Coercion</span> ANum : nat &gt;-&gt; aexp.</span><br><span class="line"></span><br><span class="line"><span class="comment">(** Coercision for functions **)</span></span><br><span class="line"><span class="keyword">Definition</span> bool_to_bexp (b : bool) : bexp := <span class="keyword">if</span> b <span class="keyword">then</span> BTrue <span class="keyword">else</span> BFalse.</span><br><span class="line"><span class="keyword">Coercion</span> bool_to_bexp : bool &gt;-&gt; bexp.</span><br><span class="line"></span><br><span class="line"><span class="comment">(** Scoped Notation **)</span></span><br><span class="line"><span class="keyword">Bind</span> <span class="keyword">Scope</span> imp_scope <span class="built_in">with</span> aexp.</span><br><span class="line"><span class="keyword">Bind</span> <span class="keyword">Scope</span> imp_scope <span class="built_in">with</span> bexp.</span><br><span class="line"></span><br><span class="line"><span class="comment">(** the Extension Point token **)</span></span><br><span class="line"><span class="keyword">Delimit</span> <span class="keyword">Scope</span> imp_scope <span class="built_in">with</span> imp.</span><br><span class="line"></span><br><span class="line"><span class="comment">(** now we can write... **)</span></span><br><span class="line"><span class="keyword">Definition</span> example_aexp := (<span class="number">3</span> + (X * <span class="number">2</span>))%imp : aexp.</span><br><span class="line"><span class="keyword">Definition</span> example_aexp : aexp := (<span class="number">3</span> + (X * <span class="number">2</span>))%imp. </span><br><span class="line"><span class="keyword">Definition</span> example_aexp := (<span class="number">3</span> + (X * <span class="number">2</span>))%imp.    <span class="comment">(* can be inferred *)</span></span><br></pre></td></tr></table></figure>


<h3 id="Evaluation-w-State-Environment"><a href="#Evaluation-w-State-Environment" class="headerlink" title="Evaluation w&#x2F; State (Environment)"></a>Evaluation w&#x2F; State (Environment)</h3><p>Noticed that the <code>st</code> has to be threaded all the way…</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Fixpoint</span> aeval (st : state) (a : aexp) : nat :=</span><br><span class="line">  <span class="keyword">match</span> a <span class="built_in">with</span></span><br><span class="line">  | <span class="type">AId</span> x ⇒ st x <span class="comment">(* &lt;--- NEW *)</span>              <span class="comment">(** lookup the environment **)</span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">Fixpoint</span> beval (st : state) (b : bexp) : bool := ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">Compute</span> (aeval (X !-&gt; <span class="number">5</span>) (<span class="number">3</span> + (X * <span class="number">2</span>))%imp). <span class="comment">(** ===&gt; 13 : nat **)</span></span><br></pre></td></tr></table></figure>





<h2 id="Commands-Statement"><a href="#Commands-Statement" class="headerlink" title="Commands (Statement)"></a>Commands (Statement)</h2><figure class="highlight bnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">c ::= SKIP | x ::= a | c ;; c | TEST b THEN c ELSE c FI | WHILE b DO c END</span><br></pre></td></tr></table></figure>

<blockquote>
<p>we use <code>TEST</code> to avoid conflicting with the <code>if</code> and <code>IF</code> notations from the standard library.</p>
</blockquote>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Inductive</span> com : <span class="keyword">Type</span> :=</span><br><span class="line">  | <span class="type">CSkip</span></span><br><span class="line">  | <span class="type">CAss</span> (x : string) (a : aexp)</span><br><span class="line">  | <span class="type">CSeq</span> (c1 c2 : com)</span><br><span class="line">  | <span class="type">CIf</span> (b : bexp) (c1 c2 : com)</span><br><span class="line">  | <span class="type">CWhile</span> (b : bexp) (c : com).</span><br></pre></td></tr></table></figure>

<p><code>notation</code> magics:</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Bind</span> <span class="keyword">Scope</span> imp_scope <span class="built_in">with</span> com.</span><br><span class="line"><span class="keyword">Notation</span> <span class="string">&quot;&#x27;SKIP&#x27;&quot;</span> := CSkip : imp_scope.</span><br><span class="line"><span class="keyword">Notation</span> <span class="string">&quot;x &#x27;::=&#x27; a&quot;</span> := (CAss x a) (<span class="built_in">at</span> level <span class="number">60</span>) : imp_scope.</span><br><span class="line"><span class="keyword">Notation</span> <span class="string">&quot;c1 ;; c2&quot;</span> := (CSeq c1 c2) (<span class="built_in">at</span> level <span class="number">80</span>, <span class="built_in">right</span> associativity) : imp_scope.</span><br><span class="line"><span class="keyword">Notation</span> <span class="string">&quot;&#x27;WHILE&#x27; b &#x27;DO&#x27; c &#x27;END&#x27;&quot;</span> := (CWhile b c) (<span class="built_in">at</span> level <span class="number">80</span>, <span class="built_in">right</span> associativity) : imp_scope.</span><br><span class="line"><span class="keyword">Notation</span> <span class="string">&quot;&#x27;TEST&#x27; c1 &#x27;THEN&#x27; c2 &#x27;ELSE&#x27; c3 &#x27;FI&#x27;&quot;</span> := (CIf c1 c2 c3) (<span class="built_in">at</span> level <span class="number">80</span>, <span class="built_in">right</span> associativity) : imp_scope.</span><br></pre></td></tr></table></figure>


<h3 id="Unset-Notations"><a href="#Unset-Notations" class="headerlink" title="Unset Notations"></a>Unset Notations</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Unset</span> <span class="keyword">Printing</span> Notations.  <span class="comment">(** e1 + e2 -&gt; APlus e1 e2 **)</span></span><br><span class="line"><span class="keyword">Set</span> <span class="keyword">Printing</span> <span class="keyword">Coercions</span>.    <span class="comment">(** n -&gt; (ANum n) **)</span></span><br><span class="line"><span class="keyword">Set</span> <span class="keyword">Printing</span> <span class="keyword">All</span>.</span><br></pre></td></tr></table></figure>

<h3 id="The-Locate-command"><a href="#The-Locate-command" class="headerlink" title="The Locate command"></a>The <code>Locate</code> command</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Locate</span> <span class="string">&quot;&amp;&amp;&quot;</span>.</span><br><span class="line"></span><br><span class="line"><span class="comment">(** give you two, [Print &quot;&amp;&amp;&quot;] only give you the default one **)</span></span><br><span class="line"><span class="keyword">Notation</span></span><br><span class="line"><span class="string">&quot;x &amp;&amp; y&quot;</span> := andb x y : bool_scope (default interpretation)</span><br><span class="line"><span class="string">&quot;x &amp;&amp; y&quot;</span> := BAnd x y : imp_scope</span><br></pre></td></tr></table></figure>







<h2 id="Evaluating-Commands"><a href="#Evaluating-Commands" class="headerlink" title="Evaluating Commands"></a>Evaluating Commands</h2><p>Noticed that to <em>use quasi-quotation in pattern matching</em>, we need</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Open</span> <span class="keyword">Scope</span> imp_scope.</span><br><span class="line">...</span><br><span class="line">  | <span class="type">x</span> ::= a1 =&gt;     <span class="comment">(**  CAss x a1  **)</span></span><br><span class="line">  | <span class="type">c1</span> ;; c2 =&gt;     <span class="comment">(**  CSeq c1 c1 **)</span></span><br><span class="line">...</span><br><span class="line"><span class="keyword">Close</span> <span class="keyword">Scope</span> imp_scope.</span><br></pre></td></tr></table></figure>


<p>An infinite loop (the <code>%imp</code> scope is inferred)</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Definition</span> loop : com :=</span><br><span class="line">  WHILE true DO</span><br><span class="line">    SKIP</span><br><span class="line">  END.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>The fact that <code>WHILE</code> loops don’t necessarily terminate makes defining an evaluation function tricky…</p>
</blockquote>
<h3 id="Evaluation-as-function-FAIL"><a href="#Evaluation-as-function-FAIL" class="headerlink" title="Evaluation as function (FAIL)"></a>Evaluation as function (FAIL)</h3><p>In OCaml&#x2F;Haskell, we simply recurse, but In Coq</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">| <span class="type">WHILE</span> b DO c END =&gt; <span class="keyword">if</span> (beval st b)</span><br><span class="line">                      <span class="keyword">then</span> ceval_fun st (c ;; WHILE b DO c END)</span><br><span class="line">                      <span class="keyword">else</span> st</span><br><span class="line"><span class="comment">(** Cannot guess decreasing argument of fix **)</span></span><br></pre></td></tr></table></figure>

<p>Well, if Coq allowed (potentially) non-terminating, the logic would be inconsistent:</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Fixpoint</span> loop_false (n : nat) : False := loop_false n.   <span class="comment">(** False is proved! **)</span></span><br></pre></td></tr></table></figure>

<h4 id="Step-Indexed-Evaluator-SUCC"><a href="#Step-Indexed-Evaluator-SUCC" class="headerlink" title="Step-Indexed Evaluator (SUCC)"></a>Step-Indexed Evaluator (SUCC)</h4><p>Chapter <code>ImpCEvalFun</code> provide some workarounds to make functional evalution works:</p>
<ol>
<li><em>step-indexed evaluator</em>, i.e. limit the recursion depth. (think about Depth-Limited Search). </li>
<li>return <code>option</code> to tell if it’s a normal or abnormal termination.</li>
<li>use <code>LETOPT...IN...</code> to reduce the “optional unwrapping” (basicaly Monadic binding <code>&gt;&gt;=</code>!)</li>
</ol>
<ul>
<li>this approach of <code>let-binding</code> became so popular in ML family.</li>
</ul>
<h3 id="Evaluation-as-Relation-SUCC"><a href="#Evaluation-as-Relation-SUCC" class="headerlink" title="Evaluation as Relation (SUCC)"></a>Evaluation as Relation (SUCC)</h3><p>Again, we are using some fancy notation <code>st=[c]=&gt;st&#39;</code> to mimic <code>⇓</code>:<br>In both PLT and TaPL, we are almost exclusively use Small-Step, but in PLC, Big-Step were used:</p>
<pre><code>                      beval st b1 = true
                       st =[ c1 ]=&gt; st&#39;
            ---------------------------------------  (E_IfTrue)
            st =[ TEST b1 THEN c1 ELSE c2 FI ]=&gt; st&#39;
</code></pre>
<p>is really:</p>
<pre><code>                        H; b1 ⇓ true
                        H; c1 ⇓ H&#39;
              ----------------------------------  (E_IfTrue)
              H; TEST b1 THEN c1 ELSE c2 FI ⇓ H&#39;
</code></pre>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Reserved</span> <span class="keyword">Notation</span> <span class="string">&quot;st &#x27;=[&#x27; c &#x27;]⇒&#x27; st&#x27;&quot;</span> (<span class="built_in">at</span> level <span class="number">40</span>).</span><br><span class="line"><span class="keyword">Inductive</span> ceval : com → state → state → <span class="keyword">Prop</span> :=</span><br><span class="line">...</span><br><span class="line">| <span class="type">E_Seq</span> : ∀c1 c2 st st&#x27; st&#x27;&#x27;,</span><br><span class="line">    st =[ c1 ]⇒ st&#x27; →</span><br><span class="line">    st&#x27; =[ c2 ]⇒ st&#x27;&#x27; →</span><br><span class="line">    st =[ c1 ;; c2 ]⇒ st&#x27;&#x27;</span><br><span class="line">| <span class="type">E_IfTrue</span> : ∀st st&#x27; b c1 c2,</span><br><span class="line">      beval st b = true →</span><br><span class="line">      st =[ c1 ]⇒ st&#x27; →</span><br><span class="line">      st =[ TEST b THEN c1 ELSE c2 FI ]⇒ st&#x27;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">where</span> <span class="string">&quot;st =[ c ]⇒ st&#x27;&quot;</span> := (ceval c st st&#x27;).</span><br></pre></td></tr></table></figure>

<p>By definition evaluation as relation (<em>in <code>Type</code> level</em>),<br>we need to construct <em>proofs</em> (<em>terms</em>) to define example.</p>
<p>…noticed that in the definition of relaiton <code>ceval</code>, we actually use the computational <code>aevel</code>, <code>beval</code>..<br>…noticed that we are using explicit <code>∀</code> style rather than constructor argument style (for IDK reason). They are the same!</p>
<h3 id="Determinism-of-Evaluation"><a href="#Determinism-of-Evaluation" class="headerlink" title="Determinism of Evaluation"></a>Determinism of Evaluation</h3><blockquote>
<p>Changing from a computational to a relational definition of evaluation is a good move because it frees us from the artificial requirement that evaluation should be a total function<br>求值不再必须是全函数</p>
</blockquote>
<blockquote>
<p>But it also raises a question: Is the second definition of evaluation really a partial function?<br>这个定义真的是偏函数吗？（这里的重点在于 偏函数 要求 right-unique 即 deterministic）</p>
</blockquote>
<p>we can prove: </p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Theorem</span> ceval_deterministic: ∀c st st1 st2,</span><br><span class="line">     st =[ c ]⇒ st1 →</span><br><span class="line">     st =[ c ]⇒ st2 →</span><br><span class="line">     st1 = st2.</span><br><span class="line"><span class="keyword">Proof</span>. ...</span><br></pre></td></tr></table></figure>








<h2 id="Reasoning-About-Imp-Programs"><a href="#Reasoning-About-Imp-Programs" class="headerlink" title="Reasoning About Imp Programs"></a>Reasoning About Imp Programs</h2><h3 id="Case-plus2-spec"><a href="#Case-plus2-spec" class="headerlink" title="Case plus2_spec"></a>Case <code>plus2_spec</code></h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Theorem</span> plus2_spec : ∀st n st&#x27;,</span><br><span class="line">  st X = n →</span><br><span class="line">  st =[ plus2 ]⇒ st&#x27; →</span><br><span class="line">  st&#x27; X = n + <span class="number">2.</span></span><br><span class="line"><span class="keyword">Proof</span>.</span><br><span class="line">  <span class="built_in">intros</span> st n st&#x27; HX Heval.</span><br></pre></td></tr></table></figure>

<p>this looks much better as inference rules: </p>
<pre><code>    H(x) = n
    H; x := x + 2 ⇓ H&#39;
  --------------------- (plus2_spec)
    H&#39;(x) = n + 2
</code></pre>
<p>By <code>inversion</code> on the Big Step eval relation, we can <em>expand</em> one step of <code>ceval</code><br>(对 derivation tree 的 expanding 过程其实就是展开我们所需的计算步骤的过程)</p>
<pre><code>  st : string -&gt; nat
  =================================
  (X !-&gt; st X + 2; st) X = st X + 2
</code></pre>
<p>In inference rule:</p>
<pre><code>  H : string → nat
  ================================
  (x ↦ H(x) + 2); H)(x) = H(x) + 2
</code></pre>
<h3 id="Case-no-whiles-terminating"><a href="#Case-no-whiles-terminating" class="headerlink" title="Case no_whiles_terminating"></a>Case <code>no_whiles_terminating</code></h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Theorem</span> no_whilesR_terminating_fail:</span><br><span class="line">   <span class="keyword">forall</span> c, no_whilesR c -&gt; <span class="keyword">forall</span> st, <span class="built_in">exists</span> st&#x27;, st =[ c ]=&gt; st&#x27;.</span><br><span class="line"><span class="keyword">Proof</span>.</span><br><span class="line">  <span class="built_in">intros</span>.</span><br><span class="line">  <span class="built_in">induction</span> H; <span class="built_in">simpl</span> <span class="built_in">in</span> *. </span><br><span class="line">  - <span class="built_in">admit</span>.</span><br><span class="line">  - <span class="built_in">admit</span>.</span><br><span class="line">  - <span class="comment">(* E_Seq *)</span></span><br></pre></td></tr></table></figure>

<p>If we <code>intros st</code> before <code>induction c</code>,<br>the IH would be <em>for particular <code>st</code></em> and too specific for <code>E_Seq</code><br>(It’s actually okay for <code>TEST</code> since both branch derive from the same <code>st</code>)</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IHno_whilesR1 : <span class="built_in">exists</span> st&#x27; : state, st =[ c1 ]=&gt; st&#x27;</span><br><span class="line">IHno_whilesR2 : <span class="built_in">exists</span> st&#x27; : state, st =[ c2 ]=&gt; st&#x27;</span><br><span class="line">============================</span><br><span class="line"><span class="built_in">exists</span> st&#x27; : state, st =[ c1;; c2 ]=&gt; st&#x27;</span><br></pre></td></tr></table></figure>

<p>So we’d love to</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">generalize</span> <span class="built_in">dependent</span> st.</span><br><span class="line"><span class="built_in">induction</span> H...</span><br><span class="line">- <span class="built_in">specialize</span> (IHno_whilesR1 st).  <span class="built_in">destruct</span> IHno_whilesR1 <span class="built_in">as</span> [st&#x27; Hc1].</span><br><span class="line">  <span class="built_in">specialize</span> (IHno_whilesR2 st&#x27;). <span class="built_in">destruct</span> IHno_whilesR2 <span class="built_in">as</span> [st&#x27;&#x27; Hc2].  <span class="comment">(* specialize [IH2] with the existential of [IH1] **)</span></span><br><span class="line">  <span class="built_in">exists</span> st&#x27;&#x27;.</span><br><span class="line">  <span class="built_in">apply</span> E_Seq <span class="built_in">with</span> (st&#x27;); <span class="built_in">assumption</span>.</span><br></pre></td></tr></table></figure>






<h2 id="Additional-Exerciese"><a href="#Additional-Exerciese" class="headerlink" title="Additional Exerciese"></a>Additional Exerciese</h2><h3 id="Stack-Compiler"><a href="#Stack-Compiler" class="headerlink" title="Stack Compiler"></a>Stack Compiler</h3><blockquote>
<p>Things that evaluate arithmetic expressions using stack:</p>
</blockquote>
<ul>
<li>Old HP Calculators</li>
<li>Forth, Postscript</li>
<li>Java Virtual Machine</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">infix:</span><br><span class="line">      (2*3)+(3*(4-2))</span><br><span class="line"></span><br><span class="line">postfix:</span><br><span class="line">      2 3 * 3 4 2 - * +</span><br><span class="line"></span><br><span class="line">stack:</span><br><span class="line">      [ ]           |    2 3 * 3 4 2 - * +</span><br><span class="line">      [2]           |    3 * 3 4 2 - * +</span><br><span class="line">      [3, 2]        |    * 3 4 2 - * +</span><br><span class="line">      [6]           |    3 4 2 - * +</span><br><span class="line">      [3, 6]        |    4 2 - * +</span><br><span class="line">      [4, 3, 6]     |    2 - * +</span><br><span class="line">      [2, 4, 3, 6]  |    - * +</span><br><span class="line">      [2, 3, 6]     |    * +</span><br><span class="line">      [6, 6]        |    +</span><br><span class="line">      [12]          |</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Goal: compiler translates <code>aexp</code> into stack machine instructions.</p>
</blockquote>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Inductive</span> sinstr : <span class="keyword">Type</span> :=</span><br><span class="line">| <span class="type">SPush</span> (n : nat)</span><br><span class="line">| <span class="type">SLoad</span> (x : string)   <span class="comment">(* load from store (heap) *)</span></span><br><span class="line">| <span class="type">SPlus</span></span><br><span class="line">| <span class="type">SMinus</span></span><br><span class="line">| <span class="type">SMult</span>.</span><br></pre></td></tr></table></figure>

<h3 id="Correct-Proof"><a href="#Correct-Proof" class="headerlink" title="Correct Proof"></a>Correct Proof</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Theorem</span> s_compile_correct : <span class="keyword">forall</span> (st : state) (e : aexp),</span><br><span class="line">  s_execute st [] (s_compile e) = [ aeval st e ].</span><br></pre></td></tr></table></figure>

<p>To prove this, we need a <em>stronger</em> induction hypothesis (i.e. more general), so we state:</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Theorem</span> s_execute_theorem : <span class="keyword">forall</span> (st : state) (e : aexp) (stack : list nat) (prog : list sinstr),</span><br><span class="line">  s_execute st stack (s_compile e ++ prog) = s_execute st ((aeval st e) :: stack) prog.</span><br></pre></td></tr></table></figure>

<p>and go through!</p>
<h3 id="IMP-Break-Continue"><a href="#IMP-Break-Continue" class="headerlink" title="IMP Break/Continue"></a>IMP <code>Break/Continue</code></h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Inductive</span> result : <span class="keyword">Type</span> :=</span><br><span class="line">  | <span class="type">SContinue</span></span><br><span class="line">  | <span class="type">SBreak</span>.</span><br></pre></td></tr></table></figure>

<p>The idea is that we can add a <em>signal</em> to notify the loop!</p>
<p>Fun to go through!</p>
<h2 id="Slide-Q-A"><a href="#Slide-Q-A" class="headerlink" title="Slide Q &amp; A"></a>Slide Q &amp; A</h2><p><code>st =[c1;;c2] =&gt; st&#39;</code></p>
<ul>
<li><p>there would be intermediate thing after inversion so… we need <em>determinism</em> to prove this!</p>
<ul>
<li>(It won’t be even true in undetermincy)</li>
</ul>
</li>
<li><p>the <code>WHILE</code> one (would diverge)</p>
<ul>
<li>true…how to prove?</li>
<li>induction on derivation…!<ul>
<li>show contradiction for all cases</li>
</ul>
</li>
</ul>
</li>
<li><p>to prove <code>¬(∃st&#39;, ...)</code>, we intro the existentials and prove the <code>False</code>.</p>
</li>
</ul>
<h3 id="Auto"><a href="#Auto" class="headerlink" title="Auto"></a><code>Auto</code></h3><p><code>auto</code> includes <code>try</code></p>
<ol>
<li><code>Proof with auto.</code></li>
<li><code>Set Intro Auto</code></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.vvbuys.com/read_sf_lf/2019-01-13-sf-lf-13-imp-parser/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vvbuys">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VVbugs Blog">
      <meta itemprop="description" content="Share some post and some issue for linux program">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | VVbugs Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/read_sf_lf/2019-01-13-sf-lf-13-imp-parser/" class="post-title-link" itemprop="url">「SF-LC」13 ImpParser</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-02 01:05:07" itemprop="dateCreated datePublished" datetime="2024-02-02T01:05:07+00:00">2024-02-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>the parser relies on some “monadic” programming idioms</p>
</blockquote>
<p>basically, <em>parser combinator</em> (But 非常麻烦 in Coq)</p>
<h2 id="Lex"><a href="#Lex" class="headerlink" title="Lex"></a>Lex</h2><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Inductive</span> chartype := white | <span class="type">alpha</span> | <span class="type">digit</span> | <span class="type">other</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Definition</span> classifyChar (c : ascii) : chartype :=</span><br><span class="line">  <span class="keyword">if</span>      isWhite c <span class="keyword">then</span> white</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> isAlpha c <span class="keyword">then</span> alpha</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> isDigit c <span class="keyword">then</span> digit</span><br><span class="line">  <span class="keyword">else</span>                   other.</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="keyword">Definition</span> token := string.</span><br></pre></td></tr></table></figure>




<h2 id="Syntax"><a href="#Syntax" class="headerlink" title="Syntax"></a>Syntax</h2><p>带 error msg 的 <code>option</code>:</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Inductive</span> optionE (X:<span class="keyword">Type</span>) : <span class="keyword">Type</span> :=</span><br><span class="line">  | <span class="type">SomeE</span> (x : X)</span><br><span class="line">  | <span class="type">NoneE</span> (s : string).       <span class="comment">(** w/ error msg **)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">Arguments</span> SomeE &#123;X&#125;.</span><br><span class="line"><span class="keyword">Arguments</span> NoneE &#123;X&#125;.</span><br></pre></td></tr></table></figure>


<p>Monadic: </p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Notation</span> <span class="string">&quot;&#x27; p &lt;- e1 ;; e2&quot;</span></span><br><span class="line">   := (<span class="keyword">match</span> e1 <span class="built_in">with</span></span><br><span class="line">       | <span class="type">SomeE</span> p ⇒ e2</span><br><span class="line">       | <span class="type">NoneE</span> err ⇒ NoneE err</span><br><span class="line">       <span class="keyword">end</span>)</span><br><span class="line">   (<span class="built_in">right</span> associativity, p <span class="built_in">pattern</span>, <span class="built_in">at</span> level <span class="number">60</span>, e1 <span class="built_in">at</span> next level).</span><br><span class="line"></span><br><span class="line"><span class="keyword">Notation</span> <span class="string">&quot;&#x27;TRY&#x27; &#x27; p &lt;- e1 ;; e2 &#x27;OR&#x27; e3&quot;</span></span><br><span class="line">   := (<span class="keyword">match</span> e1 <span class="built_in">with</span></span><br><span class="line">       | <span class="type">SomeE</span> p ⇒ e2</span><br><span class="line">       | <span class="type">NoneE</span> <span class="keyword">_</span> ⇒ e3</span><br><span class="line">       <span class="keyword">end</span>)</span><br><span class="line">   (<span class="built_in">right</span> associativity, p <span class="built_in">pattern</span>,</span><br><span class="line">    <span class="built_in">at</span> level <span class="number">60</span>, e1 <span class="built_in">at</span> next level, e2 <span class="built_in">at</span> next level).</span><br></pre></td></tr></table></figure>


<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Definition</span> parser (T : <span class="keyword">Type</span>) :=</span><br><span class="line">  list token → optionE (T * list token).</span><br></pre></td></tr></table></figure>

<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">newtype</span> <span class="type">Parser</span> a = <span class="type">Parser</span> (<span class="type">String</span> -&gt; [(<span class="title">a</span>,<span class="type">String</span>)])</span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class"><span class="keyword">instance</span> <span class="type">Monad</span> <span class="type">Parser</span> <span class="keyword">where</span></span></span><br><span class="line">   <span class="comment">-- (&gt;&gt;=) :: Parser a -&gt; (a -&gt; Parser b) -&gt; Parser b</span></span><br><span class="line">   p &gt;&gt;= f = <span class="type">P</span> (\inp -&gt; <span class="keyword">case</span> parse p inp <span class="keyword">of</span></span><br><span class="line">                           []        -&gt; []</span><br><span class="line">                           [(v,out)] -&gt; parse (f v) out)</span><br></pre></td></tr></table></figure>


<h3 id="combinator-many"><a href="#combinator-many" class="headerlink" title="combinator many"></a>combinator <code>many</code></h3><p>Coq vs. Haskell </p>
<ol>
<li>explicit recursion depth, .e. <em>step-indexed</em></li>
<li>explicit exception <code>optionE</code>  (in Haskell, it’s hidden behind the <code>Parser</code> Monad as <code>[]</code>)</li>
<li>explicit string state <code>xs</code>    (in Haskell, it’s hidden behind the <code>Parser</code> Monad as <code>String -&gt; String</code>)</li>
<li>explicit <code>acc</code>epted token     (in Haskell, it’s hidden behind the <code>Parser</code> Monad as <code>a</code>, argument)</li>
</ol>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Fixpoint</span> many_helper &#123;T&#125; (p : parser T) acc steps xs :=</span><br><span class="line">  <span class="keyword">match</span> steps, p xs <span class="built_in">with</span></span><br><span class="line">  | <span class="type">0</span>, <span class="keyword">_</span> ⇒</span><br><span class="line">      NoneE <span class="string">&quot;Too many recursive calls&quot;</span></span><br><span class="line">  | <span class="type">_</span>, NoneE <span class="keyword">_</span> ⇒</span><br><span class="line">      SomeE ((rev acc), xs)</span><br><span class="line">  | <span class="type">S</span> steps&#x27;, SomeE (t, xs&#x27;) ⇒</span><br><span class="line">      many_helper p (t :: acc) steps&#x27; xs&#x27;</span><br><span class="line">  <span class="keyword">end</span>.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Fixpoint</span> many &#123;T&#125; (p : parser T) (steps : nat) : parser (list T) :=</span><br><span class="line">  many_helper p [] steps.</span><br></pre></td></tr></table></figure>

<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">manyL</span> :: <span class="type">Parser</span> a -&gt; <span class="type">Parser</span> [a]</span><br><span class="line"><span class="title">manyL</span> p = many1L p &lt;++ return []   <span class="comment">-- left biased OR</span></span><br><span class="line"></span><br><span class="line"><span class="title">many1L</span> :: <span class="type">Parser</span> a -&gt; <span class="type">Parser</span> [a]</span><br><span class="line"><span class="title">many1L</span> p = (:) &lt;$&gt; p &lt;*&gt; manyL p</span><br><span class="line"><span class="comment">-- or</span></span><br><span class="line"><span class="title">many1L</span> p = <span class="keyword">do</span> x &lt;- p</span><br><span class="line">              xs &lt;- manyL p</span><br><span class="line">              return (x : xs)</span><br></pre></td></tr></table></figure>


<h3 id="ident"><a href="#ident" class="headerlink" title="ident"></a><code>ident</code></h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Definition</span> parseIdentifier (xs : list token) : optionE (string * list token) :=</span><br><span class="line">  <span class="keyword">match</span> xs <span class="built_in">with</span></span><br><span class="line">  | <span class="type">[] ⇒ NoneE</span> <span class="string">&quot;Expected identifier&quot;</span></span><br><span class="line">  | <span class="type">x</span>::xs&#x27; ⇒ <span class="keyword">if</span> forallb isLowerAlpha (list_of_string x)</span><br><span class="line">             <span class="keyword">then</span> SomeE (x, xs&#x27;)</span><br><span class="line">             <span class="keyword">else</span> NoneE (<span class="string">&quot;Illegal identifier:&#x27;&quot;</span> ++ x ++ <span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">  <span class="keyword">end</span>.</span><br></pre></td></tr></table></figure>

<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">ident</span> :: <span class="type">Parser</span> <span class="type">String</span></span><br><span class="line"><span class="title">ident</span> = <span class="keyword">do</span> x  &lt;- lower</span><br><span class="line">           xs &lt;- many alphanum</span><br><span class="line">           return (x:xs)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.vvbuys.com/read_sf_lf/2019-01-14-sf-lf-14-imp-ceval/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vvbuys">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VVbugs Blog">
      <meta itemprop="description" content="Share some post and some issue for linux program">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | VVbugs Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/read_sf_lf/2019-01-14-sf-lf-14-imp-ceval/" class="post-title-link" itemprop="url">「SF-LC」14 ImpCEvalFun</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-02 01:05:07" itemprop="dateCreated datePublished" datetime="2024-02-02T01:05:07+00:00">2024-02-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Step-Indexed-Evaluator"><a href="#Step-Indexed-Evaluator" class="headerlink" title="Step-Indexed Evaluator"></a>Step-Indexed Evaluator</h2><p>…Copied from <code>12-imp.md</code>:</p>
<blockquote>
<p>Chapter <code>ImpCEvalFun</code> provide some workarounds to make functional evalution works:</p>
<ol>
<li><em>step-indexed evaluator</em>, i.e. limit the recursion depth. (think about <em>Depth-Limited Search</em>). </li>
<li>return <code>option</code> to tell if it’s a normal or abnormal termination.</li>
<li>use <code>LETOPT...IN...</code> to reduce the “optional unwrapping” (basicaly Monadic binding <code>&gt;&gt;=</code>!)<br>this approach of <code>let-binding</code> became so popular in ML family.</li>
</ol>
</blockquote>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Notation</span> <span class="string">&quot;&#x27;LETOPT&#x27; x &lt;== e1 &#x27;IN&#x27; e2&quot;</span></span><br><span class="line">   := (<span class="keyword">match</span> e1 <span class="built_in">with</span></span><br><span class="line">         | <span class="type">Some</span> x ⇒ e2</span><br><span class="line">         | <span class="type">None</span> ⇒ None</span><br><span class="line">       <span class="keyword">end</span>)</span><br><span class="line">   (<span class="built_in">right</span> associativity, <span class="built_in">at</span> level <span class="number">60</span>).</span><br><span class="line"></span><br><span class="line"><span class="keyword">Open</span> <span class="keyword">Scope</span> imp_scope.</span><br><span class="line"><span class="keyword">Fixpoint</span> ceval_step (st : state) (c : com) (i : nat)</span><br><span class="line">                    : option state :=</span><br><span class="line">  <span class="keyword">match</span> i <span class="built_in">with</span></span><br><span class="line">  | <span class="type">O</span> ⇒ None       <span class="comment">(* depth-limit hit! *)</span></span><br><span class="line">  | <span class="type">S</span> i&#x27; ⇒</span><br><span class="line">    <span class="keyword">match</span> c <span class="built_in">with</span></span><br><span class="line">      | <span class="type">SKIP</span> ⇒</span><br><span class="line">          Some st</span><br><span class="line">      | <span class="type">l</span> ::= a1 ⇒</span><br><span class="line">          Some (l !-&gt; aeval st a1 ; st)</span><br><span class="line">      | <span class="type">c1</span> ;; c2 ⇒</span><br><span class="line">          LETOPT st&#x27; &lt;== ceval_step st c1 i&#x27; IN    <span class="comment">(* option bind *)</span></span><br><span class="line">          ceval_step st&#x27; c2 i&#x27;</span><br><span class="line">      | <span class="type">TEST</span> b THEN c1 ELSE c2 FI ⇒</span><br><span class="line">          <span class="keyword">if</span> (beval st b)</span><br><span class="line">            <span class="keyword">then</span> ceval_step st c1 i&#x27;</span><br><span class="line">            <span class="keyword">else</span> ceval_step st c2 i&#x27;</span><br><span class="line">      | <span class="type">WHILE</span> b1 DO c1 END ⇒</span><br><span class="line">          <span class="keyword">if</span> (beval st b1)</span><br><span class="line">          <span class="keyword">then</span> LETOPT st&#x27; &lt;== ceval_step st c1 i&#x27; IN</span><br><span class="line">               ceval_step st&#x27; c i&#x27;</span><br><span class="line">          <span class="keyword">else</span> Some st</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span>.</span><br><span class="line"><span class="keyword">Close</span> <span class="keyword">Scope</span> imp_scope.</span><br></pre></td></tr></table></figure>



<h2 id="Relational-vs-Step-Indexed-Evaluation"><a href="#Relational-vs-Step-Indexed-Evaluation" class="headerlink" title="Relational vs. Step-Indexed Evaluation"></a>Relational vs. Step-Indexed Evaluation</h2><p>Prove <code>ceval_step</code> is equiv to <code>ceval</code></p>
<h3 id=""><a href="#" class="headerlink" title="-&gt;"></a>-&gt;</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Theorem</span> ceval_step__ceval: <span class="keyword">forall</span> c st st&#x27;,</span><br><span class="line">      (<span class="built_in">exists</span> i, ceval_step st c i = Some st&#x27;) -&gt;</span><br><span class="line">      st =[ c ]=&gt; st&#x27;.</span><br></pre></td></tr></table></figure>

<p>The critical part of proof:</p>
<ul>
<li><code>destruct</code> for the <code>i</code>.</li>
<li><code>induction i</code>, generalize on all <code>st st&#39; c</code>. <ol>
<li><code>i = 0</code> case contradiction</li>
<li><code>i = S i&#39;</code> case;<br><code>destruct c</code>. <ul>
<li><code>destruct (ceval_step ...)</code> for the <code>option</code><ol>
<li><code>None</code> case contradiction</li>
<li><code>Some</code> case, use induction hypothesis…</li>
</ol>
</li>
</ul>
</li>
</ol>
</li>
</ul>
<h3 id="-1"><a href="#-1" class="headerlink" title="&lt;-"></a>&lt;-</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Theorem</span> ceval__ceval_step: <span class="keyword">forall</span> c st st&#x27;,</span><br><span class="line">      st =[ c ]=&gt; st&#x27; -&gt;</span><br><span class="line">      <span class="built_in">exists</span> i, ceval_step st c i = Some st&#x27;.</span><br><span class="line"><span class="keyword">Proof</span>.</span><br><span class="line">  <span class="built_in">intros</span> c st st&#x27; Hce.</span><br><span class="line">  <span class="built_in">induction</span> Hce.</span><br></pre></td></tr></table></figure>




      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.vvbuys.com/read_sf_lf/2019-01-15-sf-lf-15-extraction/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vvbuys">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VVbugs Blog">
      <meta itemprop="description" content="Share some post and some issue for linux program">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | VVbugs Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/read_sf_lf/2019-01-15-sf-lf-15-extraction/" class="post-title-link" itemprop="url">「SF-LC」15 Extraction</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-02 01:05:07" itemprop="dateCreated datePublished" datetime="2024-02-02T01:05:07+00:00">2024-02-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="Basic-Extraction"><a href="#Basic-Extraction" class="headerlink" title="Basic Extraction"></a>Basic Extraction</h2><ul>
<li>OCaml   (most mature)</li>
<li>Haskell (mostly works)</li>
<li>Scheme  (a bit out of date)</li>
</ul>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Extraction</span> <span class="string">&quot;imp1.ml&quot;</span> ceval_step.</span><br></pre></td></tr></table></figure>

<p>When Coq processes this command:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">The file imp1.ml has been created by extraction.</span><br><span class="line">The file imp1.mli has been created by extraction.</span><br></pre></td></tr></table></figure>



<h2 id="Controlling-Extraction-of-Specific-Types"><a href="#Controlling-Extraction-of-Specific-Types" class="headerlink" title="Controlling Extraction of Specific Types"></a>Controlling Extraction of Specific Types</h2><p>如果不做任何处理的话…生成的 <code>ml</code> 里的 <code>nat</code> 则都会是 Church Numeral…</p>
<blockquote>
<p>We can tell Coq how to extract certain <code>Inductive</code> definitions to specific OCaml types.<br>we must say:</p>
<ol>
<li>how the Coq type itself should be represented in OCaml</li>
<li>how each constructor should be translated</li>
</ol>
</blockquote>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Extract</span> <span class="keyword">Inductive</span> bool ⇒ <span class="string">&quot;bool&quot;</span> [ <span class="string">&quot;true&quot;</span> <span class="string">&quot;false&quot;</span> ].</span><br></pre></td></tr></table></figure>

<blockquote>
<p>also, for non-enumeration types (where the constructors take arguments),<br>we give an OCaml expression that can be used as a <em>“recursor”</em> over elements of the type. (Think Church numerals.)</p>
</blockquote>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Extract</span> <span class="keyword">Inductive</span> nat ⇒ <span class="string">&quot;int&quot;</span></span><br><span class="line">  [ <span class="string">&quot;0&quot;</span> <span class="string">&quot;(fun x → x + 1)&quot;</span> ]</span><br><span class="line">  <span class="string">&quot;(fun zero succ n →</span></span><br><span class="line"><span class="string">      if n=0 then zero () else succ (n-1))&quot;</span>.</span><br></pre></td></tr></table></figure>

<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Extract</span> <span class="keyword">Constant</span> plus ⇒ <span class="string">&quot;( + )&quot;</span>.</span><br><span class="line"><span class="keyword">Extract</span> <span class="keyword">Constant</span> mult ⇒ <span class="string">&quot;( * )&quot;</span>.</span><br><span class="line"><span class="keyword">Extract</span> <span class="keyword">Constant</span> eqb ⇒ <span class="string">&quot;( = )&quot;</span>.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：保证提取结果的合理性是你的责任。</p>
</blockquote>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Extract</span> <span class="keyword">Constant</span> minus ⇒ <span class="string">&quot;( - )&quot;</span>.</span><br></pre></td></tr></table></figure>

<p>比如这么做很诱人……但是我们 Coq 的定义里 <code>0 - 1 = 0</code>, OCaml 的 <code>int</code> 则会有负数…</p>
<h3 id="Recursor-的理论与实现-a-“encoding”-of-case-expression-and-sum-type"><a href="#Recursor-的理论与实现-a-“encoding”-of-case-expression-and-sum-type" class="headerlink" title="Recursor 的理论与实现 - a “encoding” of case expression and sum type"></a>Recursor 的理论与实现 - a “encoding” of case expression and sum type</h3><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Fixpoint</span> ceval_step (st : state) (c : com) (i : nat)</span><br><span class="line">                    : option state :=</span><br><span class="line">  <span class="keyword">match</span> i <span class="built_in">with</span></span><br><span class="line">  | <span class="type">O</span> =&gt; None</span><br><span class="line">  | <span class="type">S</span> i&#x27; =&gt;</span><br><span class="line">    <span class="keyword">match</span> c <span class="built_in">with</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">rec</span> ceval_step st c = <span class="keyword">function</span></span><br><span class="line">  | <span class="type">O</span> -&gt; <span class="type">None</span></span><br><span class="line">  | <span class="type">S</span> i&#x27; -&gt;</span><br><span class="line">    (<span class="keyword">match</span> c <span class="keyword">with</span></span><br></pre></td></tr></table></figure>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="keyword">rec</span> ceval_step st c i =</span><br><span class="line">  (<span class="keyword">fun</span> zero succ n -&gt; <span class="keyword">if</span> n=<span class="number">0</span> <span class="keyword">then</span> zero <span class="literal">()</span> <span class="keyword">else</span> succ (n-<span class="number">1</span>))</span><br><span class="line">    (<span class="keyword">fun</span> _ -&gt; <span class="type">None</span>)     <span class="comment">(* zero *)</span></span><br><span class="line">    (<span class="keyword">fun</span> i&#x27; -&gt;          <span class="comment">(* succ *)</span></span><br><span class="line">    <span class="keyword">match</span> c <span class="keyword">with</span></span><br></pre></td></tr></table></figure>

<p>注意我们是如何使用 “recursor” 来替代 <code>case</code>, <code>match</code>, pattern matching 得。</p>
<p>recall <em>sum type</em> 在 PLT 中的语法与语义：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">T ::= </span><br><span class="line">  T + T</span><br><span class="line"></span><br><span class="line">e ::=</span><br><span class="line">  <span class="built_in">case</span> e of</span><br><span class="line">    | <span class="type">L</span>(e) =&gt; e</span><br><span class="line">    | <span class="type">R</span>(e) =&gt; e</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">                 e → e&#x27; </span><br><span class="line">             ------------- (work inside constructor)</span><br><span class="line">             C(e) -&gt; C(e&#x27;)</span><br><span class="line"></span><br><span class="line">                 e → e&#x27; </span><br><span class="line">     -------------------------------   (work on the expr match against)</span><br><span class="line">     case e of ... →  case e&#x27; of ...</span><br><span class="line"></span><br><span class="line">-----------------------------------------------  (match Left constructor, substitute)</span><br><span class="line">case L(v) of L(x) =&gt; e1 | R(y) =&gt; e2 → e1 [v/x]</span><br><span class="line"></span><br><span class="line">-----------------------------------------------  (match Right constructor, substitute)</span><br><span class="line">case R(v) of L(x) =&gt; e1 | R(y) =&gt; e2 → e1 [v/x]</span><br></pre></td></tr></table></figure>

<p>可以发现 <code>case</code> 表达式可以理解为一种特殊的 application，会将其 argument 根据某种 tag （这里为构造函数） apply 到对应的 case body 上，<br>每个 case body 都是和 lambda abstraction 同构的一种 binder：</p>
<pre><code> L(x) =&gt; e1     ===   λx.e1
 R(x) =&gt; e2     ===   λx.e2 

 case v e1|e2   ===   (λx.e1|e2) v      -- `e1` or `e2` depends on the _tag_ wrapped on `v`
</code></pre>
<p>这个角度也解释了 Haskell&#x2F;SML 在申明函数时直接对参数写 pattern match 的理论合理性.</p>
<p>根据经验几乎所有的 <em>binding</em> 都可以被 desugar 成函数（即 lambda expression).<br>难点在于我们如何 re-implement 这个 <em>tag</em> 的 <em>switch</em> 机制?</p>
<p>对于 <code>Inductive nat</code> 翻译到 OCaml <code>int</code> 时，这个机制可以用 <code>v =? 0</code> 来判断，因此我们的 <em>recursor</em> 实现为</p>
<figure class="highlight ocaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">fun</span> zero succ                <span class="comment">(* partial application  *)</span></span><br><span class="line">  n -&gt; <span class="keyword">if</span> n=<span class="number">0</span>                <span class="comment">(* 判断 tag ... *)</span></span><br><span class="line">       <span class="keyword">then</span> zero <span class="literal">()</span>          <span class="comment">(* 0   case =&gt;  (λx.e1) v *)</span></span><br><span class="line">       <span class="keyword">else</span> succ (n-<span class="number">1</span>)       <span class="comment">(* S n case =&gt;  (λx.e2) v *)</span></span><br></pre></td></tr></table></figure>







      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.vvbuys.com/2019-09-03-vim-from-finder/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vvbuys">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VVbugs Blog">
      <meta itemprop="description" content="Share some post and some issue for linux program">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | VVbugs Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019-09-03-vim-from-finder/" class="post-title-link" itemprop="url">把「终端下的 Vim」作为 macOS Finder 的打开方式</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-02 01:05:07" itemprop="dateCreated datePublished" datetime="2024-02-02T01:05:07+00:00">2024-02-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我的日常主力编辑器主要是：</p>
<ul>
<li>(Neo)Vim</li>
<li>Spacemacs (via Emacs-plus)</li>
<li>Visual Studio Code</li>
<li>IntelliJ IDEA</li>
</ul>
<p>这里面只有 (Neo)Vim 是存活在终端中的（我并不在终端内使用 Emacs），而由于我日常主要是从终端（via iTerm）来使用电脑，所以会把他们都加入到 <code>$PATH</code> 里以方便从终端中唤起，VSCode 和 IDEA 都有一键加入的功能， Emacs 我在 <code>~/.zshrc</code> 中放了一个 <code>alias emacs=&#39;open -n -a Emacs.app .&#39;</code> 解决。</p>
<p>但是，偶尔也会有从 Finder 中打开文件的需求，这时候如果通常会打开拓展名所绑定的 <code>Open with...</code> 应用，在大部分时候我的默认绑定是 VSCode，但是今天心血来潮觉得有没有办法直接打开 Vim 呢？搜了一下还真有基于 AppleScript 的解决方案：</p>
<ol>
<li>打开 <code>Automator.app</code></li>
<li>选择 <code>New Document</code></li>
<li>找到 <code>Run AppleScript</code> 的 action 双击添加</li>
<li>编写 AppleScript 脚本来唤起终端与 vim （下文给出了我的脚本你可以直接稍作修改使用）</li>
<li>保存为 <code>Applications/iTermVim.app</code> （你可以自己随便取）</li>
<li>找到你想要以这种方式打开的文件，比如 <code>&lt;随便&gt;.markdown</code>，<code>⌘ i</code> 获取信息然后修改 <code>Open with</code> 为这个应用然后 <code>Change All...</code></li>
</ol>
<p>效果超爽 ;)</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">on</span> <span class="built_in">run</span> &#123;input, parameters&#125;</span><br><span class="line">  <span class="keyword">set</span> filename <span class="keyword">to</span> <span class="keyword">POSIX path</span> <span class="keyword">of</span> input</span><br><span class="line">  <span class="keyword">set</span> cmd <span class="keyword">to</span> <span class="string">&quot;clear; cd `dirname &quot;</span> &amp; filename &amp; <span class="string">&quot;`;vim &quot;</span> &amp; <span class="literal">quote</span> &amp; filename &amp; <span class="literal">quote</span></span><br><span class="line">  <span class="keyword">tell</span> <span class="built_in">application</span> <span class="string">&quot;iTerm&quot;</span></span><br><span class="line">    <span class="built_in">activate</span></span><br><span class="line">    <span class="keyword">tell</span> <span class="keyword">the</span> current window</span><br><span class="line">      create <span class="literal">tab</span> <span class="keyword">with</span> default profile</span><br><span class="line">      <span class="keyword">tell</span> <span class="keyword">the</span> current session</span><br><span class="line">        <span class="built_in">write</span> <span class="built_in">text</span> cmd</span><br><span class="line">      <span class="keyword">end</span> <span class="keyword">tell</span></span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">tell</span></span><br><span class="line">  <span class="keyword">end</span> <span class="keyword">tell</span></span><br><span class="line"><span class="keyword">end</span> <span class="built_in">run</span></span><br></pre></td></tr></table></figure>

<p>我这里的代码是采取是用 <code>iTerm</code> 与唤起 <code>vim</code>、窗口置前、在新窗口中打开、同时 <code>cd</code> 到目录。你也可以改成用 macOS 自带的 <code>Terminal.app</code>、在新窗口而非新 tab 打开、应用不同的 profile、或是执行其他 executable 等……任你发挥啦。</p>
<h3 id="References"><a href="#References" class="headerlink" title="References"></a>References</h3><ul>
<li><a target="_blank" rel="noopener" href="https://gist.github.com/charlietran/43639b0f4e0a01c7c20df8f1929b76f2">Open file in iTerm vim for MacOS Sierra</a></li>
<li><a target="_blank" rel="noopener" href="https://bl.ocks.org/napcs/2d8376e941133ccfad63e33bf1b1b60c">Open file in Terminal Vim on OSX</a></li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.vvbuys.com/2019-11-19-is-pwa-dead-in-2019/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vvbuys">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VVbugs Blog">
      <meta itemprop="description" content="Share some post and some issue for linux program">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | VVbugs Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2019-11-19-is-pwa-dead-in-2019/" class="post-title-link" itemprop="url">2019 年 PWA(Progressive Web App) 凉了吗？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-02 01:05:07" itemprop="dateCreated datePublished" datetime="2024-02-02T01:05:07+00:00">2024-02-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>这篇文章转载自<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/352577624/answer/901867825">我在知乎上的回答</a></p>
</blockquote>
<p>作为 PWA 在国内的早期<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25167289">布道者</a>与<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/27853228">实践者</a>，我觉得挺凉的。<br>以下都是主观感受且 opinion is my own。</p>
<p><strong>PWA（甚至整个 Web）似乎被 Google（Chrome）与「第三世界」绑到一起去了。</strong>「这世界还有多少人没上过网、没有 4G、没有 3G……印度、印度尼西亚、非洲、乌干达……」这便是这两年的 Chrome Dev Summit 的主旋律了。</p>
<p>而这或许也是现在整个 Google 的主旋律吧，于是便成了 Chrome 和 Chrome 的产品经理们的 KPI（OKR），美其名曰「为了互联网的下一个十亿用户」。我不是说关心第三世界这事不好，但问题在于<strong>你一边嘴上说着 「Open Web、大家的 Web」</strong>，<strong>一边身体上却只想着把 Web 变成「你想要的那个 Web」，然后把其他 Web 的发展方向都「耽误」掉了</strong>。</p>
<p>PWA 的商业案例至今为止，我感到 legit（正当）的仍然只有 twitter，是真正在按一个「给所有用户都能用」的标准来做的。Airbnb&#x2F;Pinterest&#x2F;Spotify 可能能及格，而其他的则要么是商业互吹（吹一波走人），要么就是利益（市场导向）一致（Instagram 以及逐年增多的印度系产品）。</p>
<p>我相信很多开发者和我一样对 PWA 的期待本来是作为 RN&#x2F;Flutter 等跨平台开发的 alternatives（替代品），结果现在连几年前的 <a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=hybrid&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:901867825%7D">hybrid</a> 方案 Cordova (Phonegap)、Electron的实力都没到， 不要说国内各种自家魔改的 Webview（容器、小程序）了。两年的时间本足以做大量这方面的工作 —— 留学前我还担心是不是两年后我就跟不上 PWA 的发展了，结果现在根本就没什么大动静 —— 每年 CDS 确实都仍然会扔几个新的有关 <a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=capability&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:901867825%7D">capability</a> 的 API 出来， 但是跟了这么多年 Chrome Dev Summit 我也算是看清了这秀场的节奏 —— 每年扔出来的东西吧，第二年弃坑 2&#x2F;3，剩下 1&#x2F;3 就是遛狗 —— virtual list 说了几年了？类似 portal 这样的 <a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=navigation-transition&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:901867825%7D">navigation-transition</a> 说了几年了？file system API 说了几年了？<strong>我吐槽的点在于，Google（Chrome）你年年画大饼，最后大部分有真正投入资源的，全是你那「第三世界」新兴市场相关的。</strong>作为 Web 开发者你一定知道，有多少新 API 落地到我们日常开发了？</p>
<p>Don’t just take my word. 你应该自己去听听这两年的 Chrome Dev Summit，是不是绝大多数的场次都围绕着对「低配」内存、CPU、<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E7%BD%91%E7%BB%9C%E7%8E%AF%E5%A2%83&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:901867825%7D">网络环境</a>的优化 —— 俨然一副「Web 就只适合在这么不行的地方用」的气息，你一个 Web 开发者都要针对 L1&#x2F;L2 Cache 优化了你说我们怎么不直接写汇编呢？而单纯谈论 CSS&#x2F;JS 等 Web 技术的发展，不带使用场景 <a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=bias&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:901867825%7D">bias</a> 的场次比例一年比一年少。至于 WebAssembly&#x2F;WebGL&#x2F;WebXR？—— who TM care? 人家连网都上不了你还想玩 3D&#x2F;VR 游戏？人家连电脑都没有你还想在 Web 上做生产力工具？WebAssembly 场靠着 Google Research 有点 AI 项目讲了讲 thread 和 SIMD 都能让我感觉到一种与整场会议违和的尴尬……而 3D, VR and AR 总共加起来就做了个六分钟的小短片播，把我乐得。</p>
<p>所谓的 Fugu Project（PWA 项目在 Google 的代号）在我眼里就是 Google<strong>「让 Web 成为他们在第三世界的开发平台」</strong>而准备的一个项目：<strong>官方提及 PWA 最爱提的用户场景不是 Web 的可索引性、可链接性、甚至都不是即开即用（on-demand），而是「用户因为没有流量和 wifi 所以不愿安装<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E5%8E%9F%E7%94%9F%E5%BA%94%E7%94%A8&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:901867825%7D">原生应用</a>」 。</strong>那几个 dev advocate 反正每年就做些 P 用都没有的玩具在那里自娱自乐自 high，做个扫雷游戏然后说我们这个一路支持到<strong>功能机用键盘来玩</strong>哦……一向亲 JSer 的 Addy Osmani 的 Adaptive Loading 场也来一句「我们要为开 <strong>Data Saver（省流量模式、无图模式</strong>）的用户做优化！」，这世界大概是又回去到了 WAP 的时代吧……而项目带头人 Alex Russell，即便我仍然很感激您过去对 Web 的影响和贡献，但您这两年来动不动就是「怼框架怼友商怼空气」—— 你们这些垃圾框架，居然要 50 KB！你们这些垃圾开发者，用什么框架，Use the platform！（i.e. 用我们的 Web Component （的框架）！）你们这些垃圾浏览器，还不快点支持我们要的 API！ —— 都是你们伤害了我的 W(K)e(P)b(I)！<strong>司马昭之心，路人皆知</strong>。</p>
<p>quote <a target="_blank" rel="noopener" href="//www.zhihu.com/people/cfdec6226ece879d2571fbc274372e9f">@尤雨溪</a></p>
<p><img src="https://pic4.zhimg.com/80/v2-82770d1b0366904c2254908d097e0a60_720w.jpg?source=1940ef5c"></p>
<p>他们在乎的是「下一个十亿用户」，中国显然不在其中呢</p>
<p>即便你也是 Web 开发者我也是 Web 开发者，但显然我们已经不是 Google（Chrome）想要支持的 Web 开发者了：当无数 Web 开发者起来为 JS 社区在应用框架的先进性上探索，当我们想要证明 Web 在今天的硬件上终于可以挑战 Native，当我们想要在动画和交互上挑战当年的 Flash，当我们认为 Web 技术已经可以胜任众多<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E6%A1%8C%E9%9D%A2%E8%BD%AF%E4%BB%B6&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:901867825%7D">桌面软件</a>，当社区期待 Web 能够积极跟进下一个新兴技术（whatever that is）甚至担当重任，当国人在谈论着 5G 的到来 Web 开发者应该做什么时 —— 这个当年挟 Web 以令 OS，推动 Web 平台 state-of-the-art 的 Google（Chrome）却变得让我不认识了。</p>
<p><strong>Web 自诞生以来便就是个<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E5%90%8C%E5%BA%8A%E5%BC%82%E6%A2%A6&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:901867825%7D">同床异梦</a>的地方 —— Web 也因此永垂不朽；而对于 PWA 能在当前 Google 的主导下迅速发展成一个有竞争力的跨平台开发解决方案这事儿，或许只是其中的又一黄粱美梦罢了。</strong></p>
<p><strong>补充两点：</strong></p>
<ul>
<li>我支持「小程序」的产品价值，也支持 PWA 作为 Web 开放标准一部分的技术价值。</li>
<li>PWA 目前主要靠 Google 推动是客观事实，且 PWA 的发展必须依赖平台（浏览器）的参与。</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.vvbuys.com/2020-04-03-react-hooks-vue-composition/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vvbuys">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VVbugs Blog">
      <meta itemprop="description" content="Share some post and some issue for linux program">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | VVbugs Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020-04-03-react-hooks-vue-composition/" class="post-title-link" itemprop="url">React Hooks 是否可以改为用类似 Vue 3 Composition API 的方式实现？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-02 01:05:07" itemprop="dateCreated datePublished" datetime="2024-02-02T01:05:07+00:00">2024-02-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>这篇文章转载自<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/378861485/answer/1125724740">我在知乎上的回答</a></p>
</blockquote>
<p><strong>不能，因为是很不一样的<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E5%BF%83%E6%99%BA%E6%A8%A1%E5%9E%8B&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:1125724740%7D">心智模型</a>（Mental Model）。</strong>我觉得很多同学只关注到了这两套 API 在功能上都能复用逻辑的相似点，而低估了两个框架体系「大背景」上的差异。</p>
<p>正文开始前我先声明一下，</p>
<ol>
<li><p>一是本文观点不代表公司。我是觉得圈子里不认同 Hooks 的声音太多了（比如 <a target="_blank" rel="noopener" href="//www.zhihu.com/people/c5198d4e9c0145aee04dd53cc6590edd">@徐飞</a> 叔叔、 <a target="_blank" rel="noopener" href="//www.zhihu.com/people/3ec3b166992a5a90a1083945d2490d38">@贺师俊</a> 贺老、 <a target="_blank" rel="noopener" href="//www.zhihu.com/people/790dccce26904cdcd11b0fad3bac37b7">@题叶</a> 同学等老朋友 no offensive），所以自愿出来平衡一下。</p>
</li>
<li><p>二是我确实好久没有实际写前端了 ，React Hooks 实战还不多，Vue 3 只草草略读了 <a href="https://link.zhihu.com/?target=https://vue-composition-api-rfc.netlify.com/">Composition API RFC</a> 与之前中文的 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/68477600">Vue Function-based API RFC</a>（所以对细节并不太熟悉。）欢迎大家务必指正、补充（与要求补充）。</p>
</li>
</ol>
<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>「框架&#x2F;库是编程语言上的抽象」，并不意味着框架的设计就无法跳脱出其实现语言的习语（idioms）与编程范式（paradiams）。</p>
<p>得益于 JavaScript 几个非常 Lisp 的特点：一等公民函数、动态类型、一定的宏支持（比如 Babel），这几年<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E5%89%8D%E7%AB%AF%E6%A1%86%E6%9E%B6&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:1125724740%7D">前端框架</a>的发展可以看到很多编程语言设计的思路：框架成为了由 DSL 与 API 构成的特定语法（syntax）、从 JavaScript 中扬弃以及由 API 附加的语义（semantics）、支撑这套体系运作的运行时（runtime）、以及所表达的心智模型（<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=mental+model&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:1125724740%7D">mental model</a>）的结合。</p>
<h2 id="Vue-3-“Reactive-Closure-based-OOP”"><a href="#Vue-3-“Reactive-Closure-based-OOP”" class="headerlink" title="Vue 3, “Reactive (Closure-based) OOP”"></a>Vue 3, “Reactive (Closure-based) OOP”</h2><p>先来看 Vue（本文中的 Vue 主要指使用 Composition API 下的 Vue）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="title class_">Counter</span> = &#123;</span><br><span class="line">  <span class="title function_">setup</span>(<span class="params">initialProps</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> count = <span class="title function_">reactive</span>(&#123;<span class="attr">count</span>: <span class="number">0</span>&#125;) <span class="comment">// or `ref(0)`</span></span><br><span class="line">    <span class="keyword">const</span> <span class="title function_">inc</span> = (<span class="params"></span>) =&gt; &#123; count.<span class="property">value</span>++ &#125;</span><br><span class="line">    <span class="keyword">return</span> &#123;count, inc&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="attr">template</span>: <span class="string">&quot;...&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>Vue 为组件挑选的语义是「对象」：Composition API 的<code>setup</code> 只会调用一次并返回一个对象合并到 <code>Counter</code> 组件上，这个对象与其成员全都是持久的引用，包括保存在 <code>inc</code> 闭包中的状态 <code>count</code> 也是持久的。渲染则是对组件上的<code>template</code> 域的具象化。</p>
<p>Vue 附加的核心语义是（基于可变数据的）「响应式（reactive）」：状态 <code>count</code> 是一个响应式对象，<code>inc</code> 进行状态更改的方式是对 <code>count</code> 直接修改，状态更改的结果是执行所有观察者（watcher）的逻辑，包括重渲染和执行副作用（<code>watchEffect</code>) ，都是基于这个语义纳入数据流。</p>
<p>有的同学（比如题主）说，如果改成返回一个 <code>render</code> 函数，<strong>直接利用闭包来保存组件变量</strong>，你还说这是对象的语义吗？</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="function">(<span class="params">props</span>) =&gt;</span> <span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onClick</span>=<span class="string">&#123;inc&#125;</span>&gt;</span>&#123;count.value&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br></pre></td></tr></table></figure>


<p>_是的_。Vue 的实现需要保持这个函数与其闭包的引用不变（referential identity）来满足状态被持久化的语义，是 JavaScript 用闭包模拟对象私有属性的经典模式<a href="#ref_1">[1]</a>。（「闭包是穷人的对象，对象是穷人的闭包」）</p>
<p>为了帮助你理解，如果我们有一门假想的 Vue 语言的话……</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hypothetical Vue lang</span></span><br><span class="line">component <span class="title class_">Counter</span> (props) &#123;    <span class="comment">// constructor</span></span><br><span class="line">  <span class="meta">@reactive</span> count = <span class="number">0</span>          <span class="comment">// field</span></span><br><span class="line">  <span class="title function_">inc</span>(<span class="params"></span>) &#123; count.<span class="property">value</span> ++ &#125;     <span class="comment">// method</span></span><br><span class="line">  <span class="title function_">render</span>(<span class="params"></span>) &#123; <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onClick</span>=<span class="string">&#123;inc&#125;</span>&gt;</span>&#123;count.value&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>是不是有基于类的 OOP 内味了？只不过 Vue 的对象是基于单例（或者闭包）而非类（或原型）实现，以及成员是被施过 reactive 魔法哒！这里我们展示了如何从概念上将 Vue 归约到 OOP 的心智模型，不过需要注意得是，Vue 整个体系（考虑状态管理、<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E6%95%B0%E6%8D%AE%E6%B5%81%E6%8E%A7%E5%88%B6&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:1125724740%7D">数据流控制</a>）的心智模型有很多 FP 的东西在里面，仍然和传统观念（比如 Java）的 OOP 有很大差别，<a href="#ref_2">[2]</a><a href="#ref_3">[3]</a>。</p>
<p>Vue 运行时的核心是 dependency tracking（依赖追踪），首先它使得 reactive 语义对用户相对 implicit（隐式），依赖都是自动收集的，大大降低了用户的心智负担。其次呢它非常细的跟踪粒度配合 Vue 使用静态化程度比较高模板使得重渲染自动就可以做到非常精准。</p>
<p>总结起来，Vue 在组件方面的心智模型仍然是「拥有数据与行为且自响应式的对象」，只要照着这个思路去想，就比较好理解「为什么 Vue 的状态可以使用可变数据结构」、「为什么 Vue 需要<code>ref</code> 包装值类型」，以及 RFC 在对比 React Hooks 时提到的「为什么 Vue 更接近大家习惯的 JS 」（这点比较主观就是了）、「为什么 Vue 的 GC 压力会更小」、「为什么 Vue 不需要手动声明依赖」等优势的由来了。</p>
<h2 id="React-“Purely-Semi-Monadic-Algebraic-FP”"><a href="#React-“Purely-Semi-Monadic-Algebraic-FP”" class="headerlink" title="React, “Purely (Semi-Monadic&#x2F;Algebraic) FP”"></a>React, “Purely (Semi-Monadic&#x2F;Algebraic) FP”</h2><p>再来看 React（本文中的 React 主要指 Hooks API 下的 React）</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Counter</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = <span class="title class_">React</span>.<span class="title function_">useState</span>(<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">const</span> <span class="title function_">inc</span> = (<span class="params"></span>) =&gt; <span class="title function_">setCount</span>(count + <span class="number">1</span>)</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onClick</span>=<span class="string">&#123;inc&#125;</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>React 为组件挑选的语义是「函数」，每次渲染都是对 <code>Counter</code> 这个函数的一次真实调用。每次 <code>useState</code> 都会执行并从 React 那取出当前的状态给 <code>count</code>，每次也都会创建一个新的 <code>inc</code> 函数（故其闭包中捕获的也是新的 <code>count</code> 值）。</p>
<p>React 附加的核心语义是一个副作用受控的「执行上下文（evaluation context）」，通俗得说就是 React 这个运行环境：状态 <code>count</code> 每次都要从 React 上下文中取出，<code>inc</code> 对状态更改的方式是用 <code>setCount</code> 更新上下文里的内容，状态更改的结果是这个函数会被重新调用，调用时函数就会从新的上下文中获得新的状态、进行重渲染和安排上（schedule）受上下文控制的副作用（<code>useEffect</code>) 。</p>
<p>为了帮助你理解，如果我们有一门假想的 React 语言的话……</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hypothetical React lang Ⅰ</span></span><br><span class="line">component <span class="title class_">Counter</span> = <span class="function">(<span class="params">props</span>) =&gt;</span>      <span class="comment">// function</span></span><br><span class="line">  <span class="meta">@context</span>.<span class="title function_">state</span>(<span class="params"><span class="number">1</span></span>) &#123;                  <span class="comment">// context provides `get_or` and `put`</span></span><br><span class="line">    count &lt;- <span class="title function_">get_or</span>(<span class="number">0</span>)              <span class="comment">// get from context (or use default value)</span></span><br><span class="line">    <span class="keyword">let</span> <span class="title function_">inc</span> = (<span class="params"></span>) =&gt; <span class="title function_">put</span>(count + <span class="number">1</span>)  <span class="comment">// callback can update the context</span></span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onClick</span>=<span class="string">&#123;inc&#125;</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>是不是有基于 Monad 的 Haskell 内味了？只不过 React 把 API 做得完全不需要你弄懂这些复杂的东西<a href="#ref_4">[4]</a>。如果你不熟悉 Monad 这个纯 FP 的概念，我们可以先不严谨<a href="#ref_5">[5]</a>得把它当做文中的「上下文」。扔出 M-bomb 的原因是大家通常把它作为在纯 FP 中处理副作用的标杆，帮助我们展示如何把 React 归约到纯 FP。</p>
<p>有的同学（比如<a target="_blank" rel="noopener" href="//www.zhihu.com/people/790dccce26904cdcd11b0fad3bac37b7">@题叶</a>）会疑惑，这怎么跟我认得的「纯函数」不一样呢，这也是「纯函数式编程」吗？其实如果我们把语法糖展开就会变成：</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">component <span class="title class_">Counter</span> = <span class="function">(<span class="params">props</span>) =&gt;</span></span><br><span class="line">  context.<span class="title function_">state</span>(<span class="number">1</span>).<span class="title function_">get_or</span>(<span class="number">0</span>).<span class="title function_">then</span>([count, put] =&gt; &#123;  <span class="comment">// `then` is monadic bind.</span></span><br><span class="line">    <span class="keyword">let</span> <span class="title function_">inc</span> = (<span class="params"></span>) =&gt; <span class="title function_">put</span>(count + <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onClock</span>=<span class="string">&#123;inc&#125;</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">  &#125;).<span class="title function_">unwrap</span>() <span class="comment">// assuming it&#x27;s safe.</span></span><br></pre></td></tr></table></figure>

<p>有没有想到同样被称作 Monad，具备异步上下文的 Promise？</p>
<p>再（过度）简化一些，你可以想象成最直白的 state-passing 风格（实际上 2018 年时 React 团队就这么考虑过类似的 API <a href="#ref_6">[6]</a>，也是 Seb 的理论基础之一<a href="#ref_7">[7]</a>）:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">component <span class="title class_">Counter</span> = <span class="function">(<span class="params">props, stateMap</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> count = stateMap.<span class="title function_">get</span>(<span class="number">1</span>, or=<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">let</span> <span class="title function_">inc</span> = (<span class="params"></span>) =&gt; stateMap.<span class="title function_">set</span>(<span class="number">1</span>, count + <span class="number">1</span>); <span class="comment">// functional update</span></span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onClick</span>=<span class="string">&#123;inc&#125;</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>不过，React 从实现到 API 设计都更靠近与追求<a href="#ref_8">[8]</a>的心智模型是一个相对较新的纯 FP 概念 —— Algebraic Effect（代数作用），虽然名字听起来相当迷惑，但其实它在描述副作用上比 Monad 反而更不花哨（少一些 ceremony），理解起来也更加容易，Dan 有一篇给 JSer 看的很易懂的博文<a href="#ref_9">[9]</a>并且有中文翻译<a href="#ref_10">[10]</a>。我们可以先把它当作「可以重新恢复的 <code>try-catch</code> 」</p>
<p>为了帮助你理解，如果我们又又又又有一门假想的 React 语言的话……</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hypothetical React lang Ⅱ</span></span><br><span class="line">component <span class="title class_">Counter</span> = <span class="function">(<span class="params">props</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> count = perform <span class="title function_">getState</span>(<span class="number">1</span>),or=<span class="number">0</span>); <span class="comment">// 1. `perform` &quot;throw&quot; effects to the context</span></span><br><span class="line">                                                <span class="comment">// 4. resume with the continuation to here</span></span><br><span class="line">  <span class="keyword">let</span> <span class="title function_">inc</span> = (<span class="params"></span>) =&gt; perform <span class="title function_">putState</span>(<span class="number">1</span>, s=count + <span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">onClick</span>=<span class="string">&#123;inc&#125;</span>&gt;</span>&#123;count&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// call site</span></span><br><span class="line"><span class="keyword">try</span> &lt;<span class="title class_">Counter</span> /&gt; handle  <span class="comment">// 2.try-handle pattern match effects</span></span><br><span class="line">                        <span class="comment">// 3. get state from the context and then resume</span></span><br><span class="line">| <span class="title function_">getState</span>(key, or) =&gt; resume <span class="keyword">with</span> context.<span class="title function_">state</span>(key) ?? or</span><br><span class="line">| <span class="title function_">putState</span>(key, s) =&gt; context.<span class="title function_">state</span>(key)=s; resume <span class="keyword">with</span> <span class="built_in">void</span></span><br></pre></td></tr></table></figure>

<p>是不是有感觉一些了？我们从组件里「扔出去」去更改 「执行上下文」里的状态，然后再「恢复」回来……</p>
<p>即便 React 已经很努力的降低了 API 的门槛，但其思维的愈加纯函数式确实会在更多程序员眼里非常「离经叛道」。</p>
<p>所以为什么我们需要「纯函数式编程」？抛开大家可能已经熟悉的声明式、数据流清晰、局部推理、易于组合外，其背后的学术理论支撑使得其在编译期静态分析与优化、运行时高并发高并行友好方面都有极高的理论上限和上升空间（近年编程原理的理论研究完全是被函数式编程霸占得）</p>
<p>React 现在运行时侧重的核心是 cooperative multitasking（协作式多任务），来为 React 加入 concurrency（并发）、schedule（调度）等底层能力。很多同学只听说过后端的高并发，其实像多任务操作系统这样的「终极 UI」就是一个高并发且依赖诸如分时（time-slicing）、优先处理（re-priortizing）等进程调度的场景。React 希望把这些技术带给 UI 开发者（比如 Suspense，比如 Selective Hydration，比如 RN 新架构中的 Fabrics），第一步是运行时用 Fiber 架构重写不依赖原生调用栈，第二步就是用 Hooks 解决 Class API 在纯度上约束力不够的问题。不纯的组件在 React 并发模式下很容易出现数据竞态（data race）的问题。</p>
<p>总结起来，React 在组件方面的心智模型是「副作用受上下文托管的纯函数」，只要照着这个思路去想，就比较好理解「为什么 React 中倾向于使用不可变数据结构」、「为什么 useEffect 默认会执行 cleanup 来保持幂等性」、「为什么 React 需要 <code>useRef</code> 这样的跨渲染 ref cell 机制来做 mutable ref 」、「为什么 React 的性能优化是 <code>useMemo</code>, <code>Memo</code> 这样 FP 风格的 memoization 」、「为什么 React 需要 <code>useMemo</code> <code>useCallback</code> 来保持 referential identity 」、「为什么 React 需要用依赖列表来进行 cache invalidation」等问题了。</p>
<h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><p>2016 年底时我就觉得 React 和 Vue 的（一个）终极区别在于「可变」还是「不可变」。</p>
<p><img src="https://pica.zhimg.com/50/v2-22e50932c60262bf381456de3017b217_720w.jpg?source=1940ef5c"></p>
<p>Seb 在 Hooks 发布后收到一些质疑的 brain dump<a href="#ref_11">[11]</a> 里写到：</p>
<blockquote>
<p>It’s interesting because there are really two approaches evolving. There’s a <strong>mutable + change tracking</strong> approach and there’s an <strong>immutability + referential equality testing</strong> approach. It’s difficult to mix and match them when you build new features on top. So that’s why React has been pushing a bit harder on immutability lately to be able to build on top of it. Both have various tradeoffs but others are doing good research in other areas, so we’ve decided to focus on this direction and see where it leads us.</p>
</blockquote>
<p>不全部翻译了，说得是整个「大前端」社区里最主要的两条道路分歧：</p>
<ul>
<li>可变 + 变更追踪。包括 Vue，Angular，</li>
<li>不可变 + 引用相等性。包括 React，Elm，(Flutter?)</li>
</ul>
<p>这个分歧其实与我之前行文的侧重点「为组件挑选的语义」其实是对偶的：</p>
<ul>
<li>前者是对传统 Imperative Programming（包括 OOP）思路的一种增强，加入了 Reactivity。</li>
<li>后者则是传统 Functional Programming 在 UI 开发领域的发扬光大（Functional Reactive Programming?)，只不过 React 是用一种比较「超越 JS 语言」的方式去实现得。</li>
</ul>
<p>这两条道路从底子就很不同，所以才造成了 React 和 Vue 在大家眼里的渐行渐远吧。</p>
<p>不过最近多看了一些 Svelte、 SwiftUI<a href="#ref_12">[12]</a>和 Jetpack Compose<a href="#ref_13">[13]</a>也开始有了一些殊途同归的感觉，Props 无论是跟着 View 销毁还是函数参数总是暂时性的输入，States 无论跟着组件实例还是置外总必须是持久化的，至于怎么判断更新，像 <code>array.push</code> 这种 mutable state 的场景总是不好 track 得，于是就只能各显神通了：React 想通过 reference equality 自动、Vue 3 想通过 Proxy 自动，但其实只要能把 change set 搞出来就行，Vue2&#x2F;Svelte&#x2F;SwiftUI&#x2F;Compose 这些让用户手动给提示得不是也工作得好好得吗？只要能把变更集算出来传递给视图层，那视图层就只管更新（rerender&#x2F;rebuild&#x2F;recomposite）就是了。</p>
<h2 id="补充-2"><a href="#补充-2" class="headerlink" title="补充 2"></a>补充 2</h2><p>如果是在重度依赖 Flux (Vuex&#x2F;Redux, whatever) 的场景，可能 Vue&#x2F;React 会更像是一个只负责渲染的 dumb&#x2F;passive layer，这种时候上文说的 Vue&#x2F;React 的差异会显得不明显，因为大部分的状态管理（state management）都已经扔到更外层去做了。</p>
<p>不过，考虑需要组件内聚的场景（即组件自己有私有状态，需要 self-conatined）以及 React Hooks &#x2F; Vue Composition APIs 开始接管更多（除状态之外的，比如 IO）副作用，这种差异只会变得越来越明显得。</p>
<p>以上。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li>JavaScript 模块化七日谈 - 黄玄的博客 Hux Blog <a target="_blank" rel="noopener" href="https://huangxuan.me/2015/07/09/js-module-7day/">https://huangxuan.me/2015/07/09/js-module-7day/</a></li>
<li>如何理解尤雨溪在 2019 VueConf 上所讲的 UI 类框架很少使用面向对象的特性这件事？- 黄玄的回答 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/328958700/answer/714287394">https://www.zhihu.com/question/328958700/answer/714287394</a></li>
<li>前端是否适合使用面向对象的方式编程？- 黄玄的回答 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/329005869/answer/739525268">https://www.zhihu.com/question/329005869/answer/739525268</a></li>
<li>React Hooks的引入会对之后的React项目开发产生什么影响？- 黄玄的回答 <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/302916879/answer/536846510">https://www.zhihu.com/question/302916879/answer/536846510</a></li>
<li>React 上下文的组合是通过调用顺序在运行时里维护一个链表而非基于参数化多态的层叠（比如 Monad Transformer）来表达，可以看到都是线性的。</li>
<li>State-passing Style Hooks <a target="_blank" rel="noopener" href="https://mobile.twitter.com/acdlite/status/971598256454098944">https://mobile.twitter.com/acdlite/status/971598256454098944</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/reactjs/react-basic">https://github.com/reactjs/react-basic</a></li>
<li>可以把上下文或者 Hooks 的调用视为一次 stack unwinding + resume continuation。同样，考虑 row polymorphism 也是线性的。</li>
<li>Algebraic Effects for the Rest of Us <a target="_blank" rel="noopener" href="https://overreacted.io/algebraic-effects-for-the-rest-of-us/">https://overreacted.io/algebraic-effects-for-the-rest-of-us/</a></li>
<li>通俗易懂的代数效应 <a target="_blank" rel="noopener" href="https://overreacted.io/zh-hans/algebraic-effects-for-the-rest-of-us/">https://overreacted.io/zh-hans/algebraic-effects-for-the-rest-of-us/</a></li>
<li>Why React <a target="_blank" rel="noopener" href="https://gist.github.com/sebmarkbage/a5ef436427437a98408672108df01919">https://gist.github.com/sebmarkbage/a5ef436427437a98408672108df01919</a></li>
<li><a target="_blank" rel="noopener" href="https://swiftwithmajid.com/2019/06/12/understanding-property-wrappers-in-swiftui/">https://swiftwithmajid.com/2019/06/12/understanding-property-wrappers-in-swiftui/</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.android.com/jetpack/compose/state#remember">https://developer.android.com/jetpack/compose/state#remember</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.vvbuys.com/2020-07-05-reflection-2020/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vvbuys">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VVbugs Blog">
      <meta itemprop="description" content="Share some post and some issue for linux program">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | VVbugs Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2020-07-05-reflection-2020/" class="post-title-link" itemprop="url">作为一个前端，看不懂@黄玄 的几乎每一个回答，只有我自己吗？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-02 01:05:07" itemprop="dateCreated datePublished" datetime="2024-02-02T01:05:07+00:00">2024-02-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>这篇文章转载自<a target="_blank" rel="noopener" href="https://www.zhihu.com/question/403735935/answer/1321904076">我在知乎上的回答</a></p>
</blockquote>
<h2 id="我也看不懂。"><a href="#我也看不懂。" class="headerlink" title="我也看不懂。"></a>我也看不懂。</h2><p>对于任何一个我有一定了解的领域，我都知道一大堆我看不懂的东西。反而是对于那些我一点都不了解的，我甚至都说不出来我不懂什么。</p>
<p>有的时候我会觉得，在我眼里还只有前端的时候，我还更自信更爱分享一点。可能因为那时候我能感知到的「边界」就只有 2^4 &#x3D; 16 这么大，还觉得自己满打满算已经懂了 4 吧。打个比喻的话就是觉得自己已经能干活了，但还想再了解下 JS 引擎、浏览器、框架等的工作原理，或许还想再多学点后端和移动端当个全栈？总之 4&#x2F;16 已经是「全集」的 25% 了，觉得自己还挺棒棒哒。</p>
<p>结果等我的「知识」真成长到 16 时，才意识到「欧，原来计算机科学还有这么多东西」？而且每个领域水都深得很，教科书里引论文，论文里再引更多论文，像一棵棵树般不断分形出去…认知的「边界」也相应的长到了 2^16 &#x3D; 65536。自己懂的东西只占 0.02%，一下觉得自己真是什么都不是了。我把这个瞎掰称之为「认知的指数成长理论」。</p>
<p>而我能做的就是学会与这样的认知和平共处。Prof. Matt Might 画的那篇 The illustrated guide to a Ph.D<a href="#ref_1">[1]</a>（<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/19789670">「博士是什么」</a>) 让我意识到个体在「人类所有知识」面前的渺小，而「成长」的过程，大概就是在那个愈发巨大的「看不懂集」里，挑选出你还愿意继续去「探索」的那些「子集」吧。</p>
<p><img src="https://picx.zhimg.com/50/v2-9557bd0507ca70f7afd075730f31a2e3_720w.jpg?source=1940ef5c"></p>
<p><img src="https://picx.zhimg.com/80/v2-9557bd0507ca70f7afd075730f31a2e3_720w.jpg?source=1940ef5c"></p>
<p>「认知的指数成长理论」</p>
<h2 id="作为一个前端。"><a href="#作为一个前端。" class="headerlink" title="作为一个前端。"></a>作为一个前端。</h2><p>在相当长的一段时间里，「前端」既是我的兴趣也是我的职业，那时好像不需要有区别 —— 从早早在阿里实习，到还没毕业就在微影带团队，小中大的公司都待过，活动也参加了不少。其实如果就这样专注于「作为一个前端」，应该现在也还混得不赖吧。</p>
<p>可是偏偏你就发现，那个「看不懂集」的边缘总在发着光 —— 群友形容有一部人的动力在于「理解驱动」，我想了想，那或许是我「半路出家」积累的太多疑惑需要解答；又或许，我可能只是想要「旅游」吧 —— 在高三从重点班理科生转了艺术，在阿里从交互又转了前端，可我还有好奇的理论、又或者还没尝试过系统编程，又或者是下一个有趣的产品形态……想去探索下一件事的欲望总是逐渐盖过了舒适感，你听说了那个学科，你听说了那个文明，你听说了风暴中心，可是你不去看，你就永远不知道那里是什么样。</p>
<p>最近多次被问及「前端团队的方向是什么？」才突然意识到自己有一段时间不这样思考了 —— 这个问题天生就带着市场环境强调<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E7%B2%BE%E7%BB%86%E5%8C%96%E5%88%86%E5%B7%A5&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:1321904076%7D">精细化分工</a>的倾向，而相反地，有时我惊讶于 Facebook 内部「疏于管理」得就像个<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E5%BC%80%E6%BA%90%E8%BD%AF%E4%BB%B6&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:1321904076%7D">开源软件</a>的菜市场。前端作为一个子领域当然需要特定的技术设施与人员的专长，但或许你我的职业&#x2F;兴趣发展、公司的组织架构、软件的开发方式，不一定都非得绑上。</p>
<p>我想要追求的状态不只是能继续做我已经擅长的事情，我还想去探索那些我想要尝试但可能还不太擅长的事情，最后再顺便把钱赚着 —— 就美其名曰「技术自由」吧。所以你说，我是前端吗，我不是前端吗？</p>
<p><img src="https://pic4.zhimg.com/50/v2-6caf0e597779eb690dffe71c0c610f54_720w.jpg?source=1940ef5c"></p>
<p><img src="https://pic4.zhimg.com/80/v2-6caf0e597779eb690dffe71c0c610f54_720w.jpg?source=1940ef5c"></p>
<p>「专注」和「职业」又何必要是一个双射呢？</p>
<h2 id="回答。"><a href="#回答。" class="headerlink" title="回答。"></a>回答。</h2><p>答题不是我的工作，我不做培训也不靠这个赚钱，不愿花时间琢磨如何哗众取宠，<br>只是有时恰好有新的感悟可以分享，有时恰好有有趣的题目能引发我的思考；</p>
<p>答题只是博客之外另一个用写作自我沉淀的地方罢了，难免会有点自我，<br>但反正也只是写给同路人看的，也为了发现与认识更多的同路人；</p>
<p>我不愿意「只」为了答题而写字，也还是希望言之有物，<br>这道题如此 meta，是回答给谁呢，又或是回答给我呢？</p>
<h2 id="结语。"><a href="#结语。" class="headerlink" title="结语。"></a>结语。</h2><p>有的时候需要赚钱，有的时候需要理想。<br>你是更想做一位黑客与画家，还是想站在 Hilbert 第十问题的肩上。</p>
<p>Gödel 说太难，人生又怎会比 Peano 简单。<br>面对的 <a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=tradeoff&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:1321904076%7D">tradeoff</a> 太多，才只能去近似一个想要的模样。</p>
<p>说得都是走心的话，走脑还是多看书吧。<br>如果能给在读的你带来一点不同思考，那便是对一个碳基生物所能给予的最高嘉奖了。</p>
<p>黄玄，<br>二〇二〇年七月五日，<br>于美国<a target="_blank" rel="noopener" href="https://www.zhihu.com/search?q=%E5%9C%A3%E5%A1%94%E5%85%8B%E6%8B%89%E6%8B%89&search_source=Entity&hybrid_search_source=Entity&hybrid_search_extra=%7B%22sourceType%22:%22answer%22,%22sourceId%22:1321904076%7D">圣塔克拉拉</a>。</p>
<p><em>「有一部分朋友知道，我现在在探索的事情跟前端关系还挺近的啦。</em><br><em>希望我也能突破我自我驱动的局限性，多做一些更落地的事情吧！共勉！」</em></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ol>
<li>The illustrated guide to a Ph.D <a target="_blank" rel="noopener" href="http://matt.might.net/articles/phd-school-in-pictures/">http://matt.might.net/articles/phd-school-in-pictures/</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.vvbuys.com/2021-04-10-js-20yrs-preface/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vvbuys">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VVbugs Blog">
      <meta itemprop="description" content="Share some post and some issue for linux program">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | VVbugs Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021-04-10-js-20yrs-preface/" class="post-title-link" itemprop="url">《JavaScript 二十年》推荐语</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-02 01:05:07" itemprop="dateCreated datePublished" datetime="2024-02-02T01:05:07+00:00">2024-02-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>雪碧（doodlewind）邀请我给<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/373065151">《JavaScript 二十年》</a> 写的推荐序。</p>
</blockquote>
<p>JavaScript 常常被戏称为一门偶然成功的玩具语言。而实际上，它出身名门，更是成长在聚光灯之下。纵观历史，有资格被标准化的编程语言甚少，它因此成为多方角力的战场，却也有幸同时得到业界与学界先驱的亲传。时至今日，我们甚至难言是它背负了太多妥协，还是这些妥协才成就了它呢。以史为鉴，或许你会有自己的答案。</p>
<p>— 黄玄，Facebook 软件工程师（编程语言、JS 引擎、前端基础设施）、中文前端社区活跃成员。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://www.vvbuys.com/2016-09-22-the-open-web/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="vvbuys">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="VVbugs Blog">
      <meta itemprop="description" content="Share some post and some issue for linux program">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | VVbugs Blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2016-09-22-the-open-web/" class="post-title-link" itemprop="url">Web 在继续离我们远去</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2024-02-02 01:05:07" itemprop="dateCreated datePublished" datetime="2024-02-02T01:05:07+00:00">2024-02-02</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>本文首发于我的知乎专栏 <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/22561084">The Little Programmer</a>，转载请保留链接 ;)</p>
</blockquote>
<p>今天微信又刷爆了我的朋友圈 —— 小程序，之前传说的应用号。</p>
<p>不过这篇不谈小程序的技术细节，也不去猜测（因为知道得很清楚……），</p>
<p>也不谈小程序会对中国互联网带来什么影响（自有产品经理会来谈……），</p>
<p>我们说说 Web，the Web。</p>
<p>我们常说的 Web，其实是 World Wide Web 的简称 the Web 的简称。</p>
<p>跟 H5 一样，这货是个简称的简称，所以简到最后就没人知道它本身是个什么意思了。</p>
<p>不要说中国老百姓分不清万维网和互联网了，美国老百姓也一样分不清 Web 和 Internet，</p>
<p>很多不求甚解的从业人士也好不到哪去，Web 常年在技术文章中被翻译得不知所云。</p>
<p>中文世界里把这件事讲得最清楚也最在乎的，非 <a target="_blank" rel="noopener" href="//www.zhihu.com/people/6bec872206d9884cd9535841b6a1f510">@不鳥萬如一</a> 莫属了。</p>
<p>比如在<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/20747514">《一天世界》博客：微信并不是在「管理」外部链接，因为微信公众号在事实上（de facto）不允许任何外部链接 - 不鳥萬通讯 - 知乎专栏</a> 里他写到：</p>
<blockquote>
<p>中文世界一直混淆<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Internet">互联网</a>（internet）和<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/World_Wide_Web">万维网</a>（web）。人们念兹在兹的「互联网开放精神」，实乃万维网的开放精神。万维网的开放主要就体现在一点：<strong>任何万维网上的文章之间都可以通过网址随意互相链接</strong>。如果我想在文章里介绍 UbuWeb 这个网站，我就可以直接在 <a target="_blank" rel="noopener" href="https://ubu.com/">UbuWeb</a> 这六个字母上添加它的网址 ubu.com。妳或许觉得这是废话，但在微信公众号的文章里妳做不到；妳只能添加微信生态圈内的链接，比如这个：<a target="_blank" rel="noopener" href="https://weixin.qq.com/cgi-bin/readtemplate%3Ft%3Dweixin_external_links_content_management_specification">https://weixin.qq.com/cgi-bin/readtemplate?t=weixin_external_links_content_management_specification</a>（即上述《规范》的链接）</p>
</blockquote>
<p>所以如一卸了微信（ <a target="_blank" rel="noopener" href="https://blog.yitianshijie.net/2016/02/21/byebye-wechat/">告别微信 一天世界</a> ）还写了：<a target="_blank" rel="noopener" href="https://blog.yitianshijie.net/2015/11/16/wechat-de-facto-lan/">微信——事实上的局域网</a> ，嗯，作为一个愈发对 Open Web 这件事 hardcore 的人来说，我是认同的。</p>
<p>如一最在乎的可能是文章，而我更在乎的是应用，Web App。</p>
<p>所谓 Web App，是 Web 的一种进化：从提供文本信息（超文本）到多媒体（超媒体）到提供软件应用服务。硬核的翻译过来大概是“基于万维网的应用”，比如你在 Web 浏览器中使用的 Youtube、Twitter、Medium、Github 等等，<strong>它们之间仍然可以通过网址（URL）随意互相链接，遵循 Web 开放标准，并且你几乎可以在任何一个具备浏览器的平台上使用这项服务，因此 Web App 同样是开放的。</strong></p>
<p>如果你听说过 Google 的 Progressive Web Apps，它其实代表的是 Progressive Open Web Apps，只是这样实在太长太啰嗦了。</p>
<p>毕竟，Web 的概念里理应包含着 Open。</p>
<p>（这篇文章的本意并不是为了 advocate PWA，但如果你对 PWA 有兴趣，欢迎阅读： <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/25167289">黄玄：下一代 Web 应用模型 — Progressive Web App​zhuanlan.zhihu.com!</a></p>
<p>如果说 Hybrid 架构还只是 Web 理想主义的一次让步，那么 React Native 的出现则无疑让部分人的信仰崩塌，然后是 Weex，然后可能是你们猜的微信。</p>
<p>眼见 “以 Web 范式为 Native 平台进行开发” 的方式越来越火，虽然受益的好像是 Web 前端从业人员，可我却不知该不该开心。</p>
<p>我不是说它们是“错误的技术方向”，从实用主义来说它们很棒，很解决问题。</p>
<p><strong>但是，无论他们长得有多像 Web，他们都不是 Open Web 平台的一员。</strong></p>
<p>RN&#x2F;Weex 根本没有 URL（别跟我说 Universal Links 或 App Links，URL 和 URI 是不同的）</p>
<p>而微信从 JS-SDK 开始，便已经是一个封闭生态了。</p>
<p>这种势头虽然缘起于 Facebook，却更可能在中国撒起野来。</p>
<p>英文世界里对这类事情敏感&#x2F;hardcore 的人很多，比如写了 <a target="_blank" rel="noopener" href="https://adactio.com/journal/10708">Regressive Web Apps</a> 的 Jeremy Keith，因为 PWA 对 URL 不够友好的事情跟 Chrome 开发老大 Alex 吵了一架，而 Alex 也急得说出了：</p>
<blockquote>
<p>so, your choices are to think that I have a secret plan to kill URLs, or conclude I’m still Team Web.</p>
</blockquote>
<p>要知道，Alex 带着 Chrome 搞 PWA 的原因就是看不爽 Hybrid 破坏了 Open Web。</p>
<p>倘若 Twitter&#x2F;FB 跟微信一样连链接还不让随便链，大概都得弃用 Twitter，然后像如一一样火冒三丈的写一篇 Byebye Twitter&#x2F;FB。</p>
<p>而国内天天鼓吹得什么 XX 助力 HTML5 生态，却不知大部分时候这些所谓 “HTML5 生态” 都是和 Web 生态背道而驰的，高下立判。</p>
<p>我开始有些语无伦次了。</p>
<p>在这个 HTML5 与 Web 被极度误用的中文世界里，我也不知道该如何呐喊了。</p>
<p>我只知道，当 Web 只能作为 Native 的 “Markup Language” 存活时，Web 也就不复存在了。</p>
<p>当大家都不跟随 Web 标准自造一套时，Web 所谓的跨平台特性也就烟消云散了。</p>
<p>我之前写过的，Chrome 产品 Leader Rahul 也在 I&#x2F;O 上说过得：</p>
<p>Web 的 Dicoverable、Linkable、Low Friction、Broad Reach 等等，这些都不是 Web 的本质，<strong>Web 的本质是 Open（开放）与 Decentralized （去中心化），这才是万维网（WWW）的初衷，这才是所有这些特性能成立的前提。</strong></p>
<p>Open Web 的信仰让浏览器厂商们重新走到了一起，他们在问你:</p>
<p><strong>Hey, can we make the web great again?</strong></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" title="Previous page" aria-label="Previous page" href="/page/18/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/18/">18</a><span class="page-number current">19</span><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" title="Next page" aria-label="Next page" href="/page/20/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">vvbuys</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
